<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¿è…è­·å¿ƒåŠ©ç† | Kidney & Heart Assistant</title>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <style>
        :root {
            --primary: #009045; --primary-dark: #007035; --accent: #F58220;
            --heart: #e91e63; --heart-light: #fce4ec; 
            --bg: #fdfdfd; --white: #ffffff; --text: #222;
            --risk-g: #6bbd45; --risk-y: #ffd700; --risk-o: #f58220; --risk-r: #e03e2e;
            --nav-height: 85px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            background: var(--bg); margin: 0; padding: 0; padding-bottom: calc(var(--nav-height) + 20px); 
            color: var(--text); font-size: 19px; line-height: 1.5; user-select: none; 
        }
        
        /* Header & Lang Selector */
        header { 
            background: var(--white); padding: 12px 15px; border-radius: 0 0 25px 25px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); position: sticky; top: 0; z-index: 100;
            display: flex; flex-direction: column; align-items: center;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 10px; }
        header::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 6px;
            background: linear-gradient(90deg, var(--primary) 30%, var(--heart) 70%);
        }
        .header-logo { height: 45px; width: auto; object-fit: contain; }
        .header-title-box { text-align: center; flex: 1; padding: 0 5px; }
        .header-title-box h1 { margin: 0; font-size: 1.6rem; color: var(--primary); font-weight: 900; line-height: 1.1; }
        .header-title-box p { margin: 3px 0 0 0; color: #666; font-size: 0.8rem; font-weight: bold; }

        .lang-selector { display: flex; gap: 5px; background: #f0f0f0; padding: 4px; border-radius: 12px; width: 100%; justify-content: space-around; }
        .lang-btn { flex: 1; border: none; background: none; padding: 6px 2px; border-radius: 8px; font-size: 0.75rem; font-weight: bold; color: #666; cursor: pointer; transition: 0.2s; }
        .lang-btn.active { background: var(--primary); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* Container & Cards */
        .container { padding: 15px; max-width: 600px; margin: 0 auto; }
        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .card { background: var(--white); border-radius: 20px; padding: 25px 20px; margin-bottom: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); text-align: center; border: 1px solid #eee; }
        .card h2 { margin-top: 0; color: var(--primary); font-size: 1.5rem; font-weight: 900; border-bottom: 3px solid #f0f4f8; padding-bottom: 15px; margin-bottom: 20px; }

        /* UI Elements */
        .input-group { margin-bottom: 25px; text-align: left; }
        .input-group label { display: block; font-size: 1.1rem; color: #444; margin-bottom: 8px; font-weight: 900; }
        .select-wrapper { position: relative; width: 100%; }
        select, input[type="number"] { width: 100%; padding: 18px; border: 2px solid #ccc; border-radius: 15px; font-size: 1.1rem; outline: none; font-weight: bold; color: #222; appearance: none; }
        .select-wrapper::after { content: 'â–¼'; position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: #444; pointer-events: none; }
        
        .option-group { display: flex; gap: 8px; width: 100%; }
        .option-btn { flex: 1; padding: 12px 5px; border: 2px solid #ddd; border-radius: 15px; background: #fff; color: #666; font-size: 1rem; font-weight: 900; text-align: center; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; line-height: 1.2; }
        .option-btn.active { border-color: var(--primary); background-color: #e8f5e9; color: var(--primary); box-shadow: 0 4px 10px rgba(0, 144, 69, 0.2); transform: scale(1.02); }
        #group-hf .option-btn.active { border-color: var(--heart); background-color: var(--heart-light); color: var(--heart); }

        .btn { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border: none; padding: 18px; width: 100%; border-radius: 18px; font-size: 1.2rem; font-weight: 900; cursor: pointer; box-shadow: 0 6px 15px rgba(0,144,69,0.3); display: flex; align-items: center; justify-content: center; text-decoration: none; margin-bottom: 15px; transition: transform 0.1s; }
        .btn:active { transform: scale(0.97); }
        .btn-outline { background: #fff; border: 3px solid var(--primary); color: var(--primary); box-shadow: none; }

        /* Risk Matrix */
        .risk-matrix { display: grid; grid-template-columns: 60px 1fr 1fr 1fr; gap: 3px; margin: 25px auto; font-size: 0.8rem; }
        .matrix-cell { display: flex; align-items: center; justify-content: center; text-align: center; padding: 2px; border-radius: 6px; font-weight: bold; height: 50px; position: relative; color: rgba(0,0,0,0.3); }
        .matrix-header { background: #f4f4f4; color: #444; font-weight: 900; padding: 5px 0; }
        .matrix-label { background: #f4f4f4; color: #444; font-weight: 900; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .bg-g { background-color: var(--risk-g); } .bg-y { background-color: var(--risk-y); } .bg-o { background-color: var(--risk-o); } .bg-r { background-color: var(--risk-r); }
        .matrix-cell.active-cell { border: 4px solid #0044cc; box-shadow: 0 0 15px rgba(0,68,204,0.6); z-index: 10; transform: scale(1.1); color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }

        .risk-banner { padding: 20px; margin-top: 25px; border-radius: 15px; color: white; text-align: center; animation: fadeIn 0.3s ease; }
        .risk-banner h3 { margin: 0; font-size: 1.6rem; font-weight: 900; }

        /* List Cards */
        .list-card { text-align: left; margin-bottom: 25px; border-radius: 15px; overflow: hidden; border: 2px solid #ddd; }
        .list-head { padding: 15px; font-weight: 900; color: white; font-size: 1.2rem; }
        .list-body { padding: 20px; font-size: 1.05rem; background: #fff; }
        .list-item { margin-bottom: 12px; border-bottom: 1px dashed #eee; padding-bottom: 12px; }
        .list-title { font-weight: 900; display: block; color: #000; margin-bottom: 3px; }

        /* Nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height); background: white; display: flex; justify-content: space-around; align-items: center; border-top: 2px solid #ccc; z-index: 1000; }
        .nav-item { text-align: center; color: #999; font-size: 0.85rem; flex: 1; padding: 5px; cursor: pointer; font-weight: 900; }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 1.8rem; display: block; margin-bottom: 2px; }

        .hidden { display: none !important; }
        
        /* Equip Box */
        .equip-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin: 20px 0; }
        .equip-slot { background: #fff; border: 3px dashed #ccc; border-radius: 15px; padding: 12px 8px; text-align: center; cursor: pointer; position: relative; display: flex; flex-direction: column; min-height: 120px; justify-content: center; }
        .equip-slot.equipped { border-style: solid; border-width: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); background: #fff; }
        .equip-name { font-size: 1rem; font-weight: 900; display: block; }
        .equip-desc { font-size: 0.8rem; color: #666; display: block; margin-top: 2px; }
        .equip-brand { font-size: 0.75rem; color: #999; font-style: italic; }
        .equip-slot.equipped::after { content: 'âœ“'; position: absolute; top: -10px; right: -5px; background: var(--primary); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        .status-panel { display: flex; align-items: center; padding: 15px; border-radius: 15px; color: white; transition: 0.5s; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .status-icon { font-size: 2.5rem; margin-right: 15px; }
        .status-title { font-size: 1.4rem; font-weight: 900; }
        
        /* Modal & Traffic */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .modal-content { background: #fff; padding: 25px; width: 90%; max-width: 500px; border-radius: 20px; position: relative; }
        .traffic-container { display: flex; justify-content: center; gap: 15px; margin: 20px 0; }
        .light { width: 60px; height: 60px; border-radius: 50%; background: #ddd; opacity: 0.2; transition: 0.3s; }
        .light.on { opacity: 1; transform: scale(1.1); box-shadow: 0 0 15px currentColor; }
    </style>
</head>
<body>

<header>
    <div class="header-top">
        <img src="logo_left.png" alt="Hospital" class="header-logo" onerror="this.style.opacity='0.2'">
        <div class="header-title-box">
            <h1 data-i18n="app-title">ä¿è…è­·å¿ƒåŠ©ç†</h1>
            <p data-i18n="app-subtitle">å¿ƒ/è…/ç³– æ™ºæ…§ç…§è­·</p>
        </div>
        <img src="logo_right_new.png" alt="Logo" class="header-logo" onerror="this.style.opacity='0.2'">
    </div>
    <div class="lang-selector">
        <button class="lang-btn active" onclick="setLang('zh')">ä¸­æ–‡</button>
        <button class="lang-btn" onclick="setLang('en')">English</button>
        <button class="lang-btn" onclick="setLang('vi')">Tiáº¿ng Viá»‡t</button>
        <button class="lang-btn" onclick="setLang('id')">Indonesian</button>
    </div>
</header>

<div class="container">

    <div id="tab-home" class="section active">
        <div class="card">
            <h2 data-i18n="home-title">ğŸ“Š é¢¨éšªè©•ä¼°</h2>
            <div style="text-align:right; margin-bottom:15px;">
                <button onclick="clearUserData()" style="background:#f5f5f5; border:1px solid #ddd; color:#666; padding:6px 12px; border-radius:20px; font-size:0.8rem; font-weight:bold;" data-i18n="btn-reset">é‡è¨­ç´€éŒ„</button>
            </div>

            <div class="input-group">
                <label data-i18n="label-age">1. å¹´é½¡</label>
                <div class="select-wrapper">
                    <select id="kfre-age" onchange="updateAllRisks()">
                        <option value="" disabled selected data-i18n="opt-select">è«‹é¸æ“‡...</option>
                        <option value="20">20-29</option><option value="30">30-39</option><option value="40">40-49</option>
                        <option value="50">50-59</option><option value="60">60-69</option><option value="70">70-79</option>
                        <option value="80">80-89</option><option value="90">90+</option>
                    </select>
                </div>
            </div>

            <div class="input-group">
                <label data-i18n="label-sex">2. æ€§åˆ¥</label>
                <div class="option-group" id="group-sex">
                    <div class="option-btn" onclick="setOption('kfre-sex', '1', this)" data-i18n="sex-m">ç”·</div>
                    <div class="option-btn" onclick="setOption('kfre-sex', '0', this)" data-i18n="sex-f">å¥³</div>
                </div>
                <input type="hidden" id="kfre-sex">
            </div>
            
            <div class="input-group">
                <label>3. eGFR <span onclick="showHelp('egfr')" style="color:#2196f3; font-size:0.9rem; text-decoration:underline; cursor:pointer;">(What's this?)</span></label>
                <div class="select-wrapper">
                    <select id="kfre-egfr" onchange="updateAllRisks()">
                        <option value="" disabled selected data-i18n="opt-select">è«‹é¸æ“‡...</option>
                        <option value="90">â‰¥ 90 (G1)</option><option value="75">60-89 (G2)</option>
                        <option value="52">45-59 (G3a)</option><option value="37">30-44 (G3b)</option>
                        <option value="22">15-29 (G4)</option><option value="10">&lt; 15 (G5)</option>
                    </select>
                </div>
            </div>

            <div class="input-group">
                <label>4. UACR (Albuminuria)</label>
                <div class="option-group" id="group-uacr">
                    <div class="option-btn active" onclick="setOption('kfre-uacr', '10', this)">&lt;30<br><span style="font-size:0.7rem;" data-i18n="uacr-n">æ­£å¸¸</span></div>
                    <div class="option-btn" onclick="setOption('kfre-uacr', '150', this)">30-300<br><span style="font-size:0.7rem;" data-i18n="uacr-m">å¾®é‡</span></div>
                    <div class="option-btn" onclick="setOption('kfre-uacr', '500', this)">&gt;300<br><span style="font-size:0.7rem;" data-i18n="uacr-s">åš´é‡</span></div>
                </div>
                <input type="hidden" id="kfre-uacr" value="10">
            </div>

            <div class="input-group">
                <label data-i18n="label-dm">5. ç³–å°¿ç—… (DM)</label>
                <div class="option-group" id="group-dm">
                    <div class="option-btn" onclick="setOption('kfre-dm', '0', this)" data-i18n="opt-no">ç„¡</div>
                    <div class="option-btn" onclick="setOption('kfre-dm', '1', this)" data-i18n="opt-yes">æœ‰</div>
                </div>
                <input type="hidden" id="kfre-dm">
            </div>

            <div class="input-group">
                <label data-i18n="label-hf">6. å¿ƒè¡°ç«­ (HF)</label>
                <div class="option-group" id="group-hf">
                    <div class="option-btn" onclick="setOption('kfre-hf', '0', this)" data-i18n="opt-no">ç„¡</div>
                    <div class="option-btn" onclick="setOption('kfre-hf', '1', this)" data-i18n="opt-yes">æœ‰</div>
                </div>
                <input type="hidden" id="kfre-hf">
            </div>

            <div id="unified-result" class="hidden">
                <div id="risk-banner" class="risk-banner">
                    <h3 id="risk-title">--</h3>
                    <p id="risk-desc">--</p>
                </div>
                
                <div id="kfre-result-box" style="margin-top:20px; padding:20px; border-radius:15px; border:2px solid #ddd;">
                    <h4 data-i18n="kfre-title">ğŸ“… æœªä¾†æ´—è…é¢¨éšªé æ¸¬</h4>
                    <div style="display:flex; justify-content:space-around;">
                        <div><div style="font-size:0.8rem;" data-i18n="kfre-2yr">2å¹´å…§</div><div id="res-2yr" style="font-size:1.8rem; font-weight:900;">--%</div></div>
                        <div><div style="font-size:0.8rem;" data-i18n="kfre-5yr">5å¹´å…§</div><div id="res-5yr" style="font-size:1.8rem; font-weight:900;">--%</div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-meds" class="section">
        <div class="card">
            <h2 data-i18n="nav-meds">ğŸ’Š ç”¨è—¥å»ºè­°</h2>
            <div id="med-content">
                <div class="list-card" style="border-color: var(--risk-g);"><div class="list-head" style="background: var(--risk-g);" data-i18n="med-g">ğŸŸ¢ æ ¸å¿ƒæ²»ç™‚</div><div class="list-body" id="list-med-g"></div></div>
                <div class="list-card" style="border-color: var(--risk-y);"><div class="list-head" style="background: var(--risk-y); color:#333;" data-i18n="med-y">ğŸŸ¡ éœ€è¬¹æ…</div><div class="list-body" id="list-med-y"></div></div>
                <div class="list-card" style="border-color: var(--risk-r);"><div class="list-head" style="background: var(--risk-r);" data-i18n="med-r">ğŸ”´ æ‡‰é¿å…</div><div class="list-body" id="list-med-r"></div></div>
            </div>
        </div>

        <div class="card">
            <h2 data-i18n="sickday-title">ğŸ¤¢ ç”Ÿç—…æ—¥åœè—¥å®ˆå‰‡</h2>
            <p style="font-size:0.9rem; color:#d32f2f; font-weight:bold;" data-i18n="sickday-desc">ç•¶æ‚¨ç™¼ç”Ÿæ‹‰è‚šå­ã€ç™¼ç‡’ã€è„«æ°´æ™‚ï¼Œè«‹è«®è©¢é†«å¸«æ˜¯å¦æš«åœï¼š</p>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
                <div style="padding:10px; border:2px solid #ffcc80; border-radius:10px; font-weight:bold;">SGLT2i / Metformin</div>
                <div style="padding:10px; border:2px solid #ffcc80; border-radius:10px; font-weight:bold;">ACEi / ARB</div>
                <div style="padding:10px; border:2px solid #ffcc80; border-radius:10px; font-weight:bold;">Diuretics</div>
                <div style="padding:10px; border:2px solid #ffcc80; border-radius:10px; font-weight:bold;">NSAIDs</div>
            </div>
        </div>
    </div>

    <div id="tab-diet" class="section">
        <div class="card">
            <h2 data-i18n="nav-diet">ğŸ¥¦ é£²é£Ÿå»ºè­°</h2>
            <div id="diet-content">
                <div id="protein-box" style="background:#e8f5e9; padding:15px; border-radius:15px; margin-bottom:15px; border:2px dashed var(--primary);">
                    <div style="font-weight:900; color:var(--primary);" data-i18n="diet-p-title">ğŸ¥© æ¯æ—¥è›‹ç™½è³ªå»ºè­°</div>
                    <div id="protein-val" style="font-size:2rem; font-weight:900; color:var(--primary);">-- g/kg</div>
                </div>
                <div class="list-card" style="border-color: var(--risk-g);"><div class="list-head" style="background: var(--risk-g);" data-i18n="diet-g">ğŸŸ¢ å»ºè­°æ”å–</div><div class="list-body" id="list-diet-g"></div></div>
                <div class="list-card" style="border-color: var(--risk-r);"><div class="list-head" style="background: var(--risk-r);" data-i18n="diet-r">ğŸ”´ æ‡‰é¿å…</div><div class="list-body" id="list-diet-r"></div></div>
            </div>
        </div>
        
        <div class="card">
            <h2 data-i18n="food-search-title">ğŸš¦ é£Ÿç‰©ç´…ç¶ ç‡ˆæŸ¥è©¢</h2>
            <input type="text" id="food-search" oninput="filterFood()" style="width:100%; padding:15px; border-radius:30px; border:2px solid #ddd; margin-bottom:15px;" placeholder="Search food...">
            <div id="food-list" style="text-align:left;"></div>
        </div>
    </div>

    <div id="tab-quiz" class="section">
        <div class="card">
            <h2 data-i18n="armor-title">ğŸ›¡ï¸ è­·è…è£å‚™æª¢æŸ¥</h2>
            <p style="font-size:0.9rem; color:#666;" data-i18n="armor-desc">è«‹å‹¾é¸æ‚¨æ­£åœ¨ä½¿ç”¨çš„è—¥ç‰©ï¼Œæª¢è¦–ä¿è­·åŠ›ï¼š</p>
            <div class="equip-grid" id="armor-grid">
                </div>
            <div id="status-panel" class="status-panel" style="background:#eee; color:#666;">
                <div class="status-icon">âš ï¸</div>
                <div class="status-info">
                    <div class="status-title" id="status-title">---</div>
                </div>
            </div>
        </div>
    </div>

</div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('home')"><span class="nav-icon">ğŸ </span><span data-i18n="nav-home">é¦–é </span></div>
    <div class="nav-item" onclick="switchTab('meds')"><span class="nav-icon">ğŸ’Š</span><span data-i18n="nav-meds">ç”¨è—¥</span></div>
    <div class="nav-item" onclick="switchTab('diet')"><span class="nav-icon">ğŸ¥¦</span><span data-i18n="nav-diet">é£²é£Ÿ</span></div>
    <div class="nav-item" onclick="switchTab('quiz')"><span class="nav-icon">ğŸ›¡ï¸</span><span data-i18n="nav-armor">è£å‚™</span></div>
</nav>

<script>
    // --- ğŸŒ å¤šåœ‹èªè¨€å­—å…¸ ---
    const i18n = {
        zh: {
            "app-title": "ä¿è…è­·å¿ƒåŠ©ç†", "app-subtitle": "å¿ƒ/è…/ç³– æ™ºæ…§ç…§è­·",
            "home-title": "ğŸ“Š é¢¨éšªè©•ä¼°", "btn-reset": "é‡è¨­ç´€éŒ„",
            "label-age": "1. å¹´é½¡", "label-sex": "2. æ€§åˆ¥", "label-dm": "5. ç³–å°¿ç—… (DM)", "label-hf": "6. å¿ƒè¡°ç«­ (HF)",
            "sex-m": "ç”·", "sex-f": "å¥³", "opt-select": "è«‹é¸æ“‡...", "opt-yes": "æœ‰", "opt-no": "ç„¡",
            "uacr-n": "æ­£å¸¸", "uacr-m": "å¾®é‡", "uacr-s": "åš´é‡",
            "kfre-title": "ğŸ“… æœªä¾†æ´—è…é¢¨éšªé æ¸¬", "kfre-2yr": "2å¹´å…§", "kfre-5yr": "5å¹´å…§",
            "nav-home": "é¦–é ", "nav-meds": "ç”¨è—¥", "nav-diet": "é£²é£Ÿ", "nav-armor": "è£å‚™",
            "med-g": "ğŸŸ¢ æ ¸å¿ƒæ²»ç™‚", "med-y": "ğŸŸ¡ éœ€è¬¹æ…", "med-r": "ğŸ”´ æ‡‰é¿å…",
            "sickday-title": "ğŸ¤¢ ç”Ÿç—…æ—¥åœè—¥å®ˆå‰‡", "sickday-desc": "ç•¶æ‚¨ç™¼ç”Ÿè…¹ç€‰ã€ç™¼ç‡’ã€è„«æ°´æ™‚ï¼Œè«‹è«®è©¢é†«å¸«æš«åœä»¥ä¸‹è—¥ç‰©ï¼š",
            "diet-p-title": "ğŸ¥© æ¯æ—¥è›‹ç™½è³ªå»ºè­°", "diet-g": "ğŸŸ¢ å»ºè­°æ”å–", "diet-r": "ğŸ”´ æ‡‰é¿å…",
            "food-search-title": "ğŸš¦ é£Ÿç‰©ç´…ç¶ ç‡ˆ", "armor-title": "ğŸ›¡ï¸ è­·è…è£å‚™æª¢æŸ¥", "armor-desc": "è«‹å‹¾é¸æ‚¨ç›®å‰æ­£åœ¨æœç”¨çš„è—¥ç‰©ï¼š",
            "rank-0": "å°šæœªå»ºç«‹é˜²è­·", "rank-1": "åŸºç¤é˜²è­·", "rank-2": "ç©©å›ºé˜²è­·", "rank-3": "å¼·åŠ›é˜²è­·", "rank-4": "å®Œç¾é˜²è­·"
        },
        en: {
            "app-title": "Kidney & Heart Assistant", "app-subtitle": "Smart Care for CKD/HF/DM",
            "home-title": "ğŸ“Š Risk Assessment", "btn-reset": "Reset",
            "label-age": "1. Age", "label-sex": "2. Gender", "label-dm": "5. Diabetes (DM)", "label-hf": "6. Heart Failure (HF)",
            "sex-m": "Male", "sex-f": "Female", "opt-select": "Select...", "opt-yes": "Yes", "opt-no": "No",
            "uacr-n": "Normal", "uacr-m": "Micro", "uacr-s": "Macro",
            "kfre-title": "ğŸ“… Kidney Failure Risk", "kfre-2yr": "In 2yr", "kfre-5yr": "In 5yr",
            "nav-home": "Home", "nav-meds": "Meds", "nav-diet": "Diet", "nav-armor": "Armor",
            "med-g": "ğŸŸ¢ Core Therapy", "med-y": "ğŸŸ¡ Caution", "med-r": "ğŸ”´ Avoid",
            "sickday-title": "ğŸ¤¢ Sick Day Rules", "sickday-desc": "If you have diarrhea, fever, or dehydration, ask your doctor about stopping:",
            "diet-p-title": "ğŸ¥© Daily Protein", "diet-g": "ğŸŸ¢ Recommended", "diet-r": "ğŸ”´ Avoid",
            "food-search-title": "ğŸš¦ Food Traffic Light", "armor-title": "ğŸ›¡ï¸ Equipment Check", "armor-desc": "Check the meds you are currently taking:",
            "rank-0": "No Protection", "rank-1": "Basic", "rank-2": "Solid", "rank-3": "Strong", "rank-4": "Perfect"
        },
        vi: {
            "app-title": "Trá»£ lÃ½ Tháº­n & Tim", "app-subtitle": "ChÄƒm sÃ³c CKD/HF/DM",
            "home-title": "ğŸ“Š ÄÃ¡nh giÃ¡ rá»§i ro", "btn-reset": "Äáº·t láº¡i",
            "label-age": "1. Tuá»•i", "label-sex": "2. Giá»›i tÃ­nh", "label-dm": "5. Tiá»ƒu Ä‘Æ°á»ng", "label-hf": "6. Suy tim",
            "sex-m": "Nam", "sex-f": "Ná»¯", "opt-select": "Chá»n...", "opt-yes": "CÃ³", "opt-no": "KhÃ´ng",
            "uacr-n": "BÃ¬nh thÆ°á»ng", "uacr-m": "Nháº¹", "uacr-s": "Náº·ng",
            "kfre-title": "ğŸ“… Nguy cÆ¡ suy tháº­n", "kfre-2yr": "Trong 2 nÄƒm", "kfre-5yr": "Trong 5 nÄƒm",
            "nav-home": "Trang chá»§", "nav-meds": "Thuá»‘c", "nav-diet": "Ä‚n uá»‘ng", "nav-armor": "Trang bá»‹",
            "med-g": "ğŸŸ¢ Äiá»u trá»‹ chÃ­nh", "med-y": "ğŸŸ¡ Tháº­n trá»ng", "med-r": "ğŸ”´ TrÃ¡nh dÃ¹ng",
            "sickday-title": "ğŸ¤¢ Quy táº¯c ngÃ y á»‘m", "sickday-desc": "Náº¿u bá»‹ tiÃªu cháº£y, sá»‘t hoáº·c máº¥t nÆ°á»›c, hÃ£y há»i bÃ¡c sÄ© vá» viá»‡c ngá»«ng thuá»‘c:",
            "diet-p-title": "ğŸ¥© Äáº¡m hÃ ng ngÃ y", "diet-g": "ğŸŸ¢ NÃªn Äƒn", "diet-r": "ğŸ”´ Cáº§n trÃ¡nh",
            "food-search-title": "ğŸš¦ ÄÃ¨n giao thÃ´ng thá»±c pháº©m", "armor-title": "ğŸ›¡ï¸ Kiá»ƒm tra trang bá»‹", "armor-desc": "ÄÃ¡nh dáº¥u cÃ¡c loáº¡i thuá»‘c báº¡n Ä‘ang uá»‘ng:",
            "rank-0": "ChÆ°a báº£o vá»‡", "rank-1": "CÆ¡ báº£n", "rank-2": "á»”n Ä‘á»‹nh", "rank-3": "Máº¡nh máº½", "rank-4": "HoÃ n háº£o"
        },
        id: {
            "app-title": "Asisten Ginjal & Jantung", "app-subtitle": "Perawatan CKD/HF/DM",
            "home-title": "ğŸ“Š Evaluasi Risiko", "btn-reset": "Atur Ulang",
            "label-age": "1. Usia", "label-sex": "2. Jenis Kelamin", "label-dm": "5. Diabetes", "label-hf": "6. Gagal Jantung",
            "sex-m": "Laki-laki", "sex-f": "Perempuan", "opt-select": "Pilih...", "opt-yes": "Ya", "opt-no": "Tidak",
            "uacr-n": "Normal", "uacr-m": "Ringan", "uacr-s": "Berat",
            "kfre-title": "ğŸ“… Risiko Gagal Ginjal", "kfre-2yr": " dlm 2 thn", "kfre-5yr": "dlm 5 thn",
            "nav-home": "Beranda", "nav-meds": "Obat", "nav-diet": "Diet", "nav-armor": "Armor",
            "med-g": "ğŸŸ¢ Terapi Utama", "med-y": "ğŸŸ¡ Hati-hati", "med-r": "ğŸ”´ Hindari",
            "sickday-title": "ğŸ¤¢ Aturan Hari Sakit", "sickday-desc": "Jika diare, demam, atau dehidrasi, tanya dokter tentang menghentikan:",
            "diet-p-title": "ğŸ¥© Protein Harian", "diet-g": "ğŸŸ¢ Disarankan", "diet-r": "ğŸ”´ Hindari",
            "food-search-title": "ğŸš¦ Lampu Lalu Lintas Makanan", "armor-title": "ğŸ›¡ï¸ Cek Peralatan", "armor-desc": "Centang obat yang Anda minum:",
            "rank-0": "Belum Terlindungi", "rank-1": "Dasar", "rank-2": "Solid", "rank-3": "Kuat", "rank-4": "Sempurna"
        }
    };

    let currentLang = 'zh';

    function setLang(lang) {
        currentLang = lang;
        document.querySelectorAll('.lang-btn').forEach(b => {
            b.classList.toggle('active', b.getAttribute('onclick').includes(`'${lang}'`));
        });
        
        // Translate Static Text
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (i18n[lang][key]) el.innerText = i18n[lang][key];
        });

        // Refresh dynamic content
        updateAllRisks();
        saveUserData();
    }

    // --- ğŸ’Š Medication Database (Multi-lang) ---
    const medDB = {
        'sglt2': { zh: 'æ’ç³–è—¥ (SGLT2i)', en: 'SGLT2i', vi: 'Thuá»‘c tháº£i Ä‘Æ°á»ng SGLT2i', id: 'Obat pembuang gula SGLT2i' },
        'rasi': { zh: 'è¡€å£“è—¥ (ACEi/ARB)', en: 'ACEi/ARB', vi: 'Thuá»‘c huyáº¿t Ã¡p ACEi/ARB', id: 'Obat darah tinggi ACEi/ARB' },
        'arni': { zh: 'å¿ƒè¡°ç«­è—¥ (ARNI)', en: 'ARNI', vi: 'Thuá»‘c suy tim ARNI', id: 'Obat gagal jantung ARNI' },
        'bb': { zh: 'ä¹™å‹é˜»æ–·åŠ‘ (Beta-blocker)', en: 'Beta-blocker', vi: 'Thuá»‘c cháº¹n beta', id: 'Penyekat beta' },
        'nsaid': { zh: 'å¼·æ•ˆæ­¢ç—›è—¥ (NSAIDs)', en: 'NSAIDs (Painkillers)', vi: 'Thuá»‘c giáº£m Ä‘au máº¡nh', id: 'Obat pereda nyeri kuat' }
    };

    // --- ğŸ¥¦ Food Database (Simplified for demo) ---
    const foodDB = {
        'starfruit': { n: {zh:'æ¥Šæ¡ƒ', en:'Starfruit', vi:'Kháº¿', id:'Belimbing'}, t: 'ğŸ”´', d: {zh:'å«ç¥ç¶“æ¯’ç´ ï¼Œçµ•å°ç¦é£Ÿ', en:'Contains neurotoxins, strictly avoid', vi:'CÃ³ chá»©a Ä‘á»™c tá»‘ tháº§n kinh, tuyá»‡t Ä‘á»‘i khÃ´ng Äƒn', id:'Mengandung neurotoksin, hindari sama sekali'} },
        'banana': { n: {zh:'é¦™è•‰', en:'Banana', vi:'Chuá»‘i', id:'Pisang'}, t: 'ğŸ”´', d: {zh:'é«˜é‰€æ°´æœ', en:'High potassium', vi:'Nhiá»u kali', id:'Tinggi kalium'} },
        'cabbage': { n: {zh:'é«˜éº—èœ', en:'Cabbage', vi:'Báº¯p cáº£i', id:'Kubis'}, t: 'ğŸŸ¢', d: {zh:'ä½é‰€è”¬èœï¼Œå®‰å¿ƒé£Ÿç”¨', en:'Low potassium', vi:'Ãt kali', id:'Rendah kalium'} }
    };

    // --- âš™ï¸ Logic Core ---
    function setOption(id, val, btn) {
        document.getElementById(id).value = val;
        btn.parentElement.querySelectorAll('.option-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        updateAllRisks();
    }

    function switchTab(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('tab-' + id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        const idx = {home:0, meds:1, diet:2, quiz:3}[id];
        document.querySelectorAll('.nav-item')[idx].classList.add('active');
        window.scrollTo(0,0);
    }

    function updateAllRisks() {
        const age = parseFloat(document.getElementById('kfre-age').value);
        const sex = document.getElementById('kfre-sex').value;
        const egfr = parseFloat(document.getElementById('kfre-egfr').value);
        const uacr = parseFloat(document.getElementById('kfre-uacr').value);
        const hasDM = document.getElementById('kfre-dm').value === '1';
        const hasHF = document.getElementById('kfre-hf').value === '1';

        if (isNaN(age) || sex === "" || isNaN(egfr) || isNaN(uacr)) return;

        document.getElementById('unified-result').classList.remove('hidden');
        
        // KFRE Logic
        const sexNum = parseFloat(sex);
        const sum = -0.2201 * (age/10 - 7.036) + 0.2467 * (sexNum - 0.5642) - 0.5567 * (egfr/5 - 7.222) + 0.4510 * (Math.log(uacr) - 5.137);
        const risk2 = (1 - Math.pow(0.9832, Math.exp(sum))) * 100;
        const risk5 = (1 - Math.pow(0.9365, Math.exp(sum))) * 100;

        document.getElementById('res-2yr').innerText = risk2.toFixed(1) + "%";
        document.getElementById('res-5yr').innerText = risk5.toFixed(1) + "%";

        // Dynamic Lists
        updateMedsList(egfr, hasDM, hasHF);
        updateDietList(egfr, hasDM, hasHF);
        renderArmor(hasDM, hasHF, egfr);
    }

    function updateMedsList(egfr, hasDM, hasHF) {
        const g = document.getElementById('list-med-g'), y = document.getElementById('list-med-y'), r = document.getElementById('list-med-r');
        g.innerHTML = ''; y.innerHTML = ''; r.innerHTML = '';
        
        const add = (l, txt) => l.innerHTML += `<div class="list-item"><b>${txt}</b></div>`;
        
        if (egfr >= 20) add(g, medDB.sglt2[currentLang]);
        if (hasHF) add(g, medDB.arni[currentLang]); else add(g, medDB.rasi[currentLang]);
        add(r, medDB.nsaid[currentLang]);
    }

    function updateDietList(egfr, hasDM, hasHF) {
        const pVal = document.getElementById('protein-val');
        const g = document.getElementById('list-diet-g'), r = document.getElementById('list-diet-r');
        g.innerHTML = ''; r.innerHTML = '';
        
        pVal.innerText = (egfr < 45 ? "0.6~0.8" : "0.8~1.0") + " g/kg";
        
        const items = {
            zh: { g: 'å„ªè³ªè›‹ç™½(é­šã€è‚‰ã€è›‹)', r: 'æ¥Šæ¡ƒã€åŠ å·¥è‚‰å“ã€èœæ¹¯' },
            en: { g: 'High quality protein', r: 'Starfruit, Processed meat' },
            vi: { g: 'Äáº¡m cháº¥t lÆ°á»£ng cao', r: 'Kháº¿, Thá»‹t cháº¿ biáº¿n' },
            id: { g: 'Protein berkualitas', r: 'Belimbing, Daging olahan' }
        };
        g.innerHTML = `<div class="list-item">${items[currentLang].g}</div>`;
        r.innerHTML = `<div class="list-item">${items[currentLang].r}</div>`;
    }

    function filterFood() {
        const q = document.getElementById('food-search').value.toLowerCase();
        const list = document.getElementById('food-list');
        list.innerHTML = '';
        Object.keys(foodDB).forEach(key => {
            const f = foodDB[key];
            if (f.n[currentLang].toLowerCase().includes(q)) {
                list.innerHTML += `<div class="list-item"><b>${f.t} ${f.n[currentLang]}</b><br><small>${f.d[currentLang]}</small></div>`;
            }
        });
    }

    function renderArmor(hasDM, hasHF, egfr) {
        const grid = document.getElementById('armor-grid');
        grid.innerHTML = '';
        const meds = [];
        meds.push({id:'drug-sglt2', n: medDB.sglt2[currentLang]});
        if(hasHF) meds.push({id:'drug-arni', n: medDB.arni[currentLang]});
        else meds.push({id:'drug-rasi', n: medDB.rasi[currentLang]});
        if(hasHF) meds.push({id:'drug-bb', n: medDB.bb[currentLang]});

        meds.forEach(m => {
            grid.innerHTML += `
                <div class="equip-slot" id="slot-${m.id}" onclick="toggleArmor('${m.id}')">
                    <span class="equip-name">${m.n}</span>
                    <input type="checkbox" id="${m.id}" class="hidden" style="display:none">
                </div>
            `;
        });
    }

    function toggleArmor(id) {
        const cb = document.getElementById(id);
        cb.checked = !cb.checked;
        document.getElementById('slot-'+id).classList.toggle('equipped', cb.checked);
        updateArmorStatus();
    }

    function updateArmorStatus() {
        const count = document.querySelectorAll('.equip-slot.equipped').length;
        const status = document.getElementById('status-panel');
        const title = document.getElementById('status-title');
        title.innerText = i18n[currentLang][`rank-${count}`] || i18n[currentLang][`rank-0`];
        status.style.background = count > 0 ? 'var(--primary)' : '#eee';
        status.style.color = count > 0 ? '#fff' : '#666';
        saveUserData();
    }

    // --- ğŸ’¾ Storage ---
    function saveUserData() {
        const data = {
            lang: currentLang,
            age: document.getElementById('kfre-age').value,
            sex: document.getElementById('kfre-sex').value,
            egfr: document.getElementById('kfre-egfr').value,
            dm: document.getElementById('kfre-dm').value,
            hf: document.getElementById('kfre-hf').value
        };
        localStorage.setItem('ckd_app_data', JSON.stringify(data));
    }

    function loadUserData() {
        const raw = localStorage.getItem('ckd_app_data');
        if (raw) {
            const data = JSON.parse(raw);
            if(data.lang) setLang(data.lang);
            if(data.age) document.getElementById('kfre-age').value = data.age;
            if(data.egfr) document.getElementById('kfre-egfr').value = data.egfr;
            // Simplified restoration for demo
            updateAllRisks();
        }
    }

    function clearUserData() { if(confirm('Reset?')) { localStorage.clear(); location.reload(); } }

    window.onload = loadUserData;
</script>

</body>
</html>
