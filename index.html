<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è…åˆ©ç®¡å®¶ v7.4 (é‚è¼¯æ ¡æ­£ç‰ˆ)</title>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <style>
        :root {
            --primary: #009045; --primary-dark: #007035; --accent: #F58220;
            --bg: #fdfdfd; --white: #ffffff; --text: #222;
            --risk-g: #6bbd45; --risk-y: #ffd700; --risk-o: #f58220; --risk-r: #e03e2e;
            --nav-height: 85px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            background: var(--bg); margin: 0; padding: 0; padding-bottom: calc(var(--nav-height) + 20px); 
            color: var(--text); font-size: 19px; line-height: 1.5; user-select: none; 
        }
        
        /* Header */
        header { 
            background: var(--white); padding: 12px 15px; border-radius: 0 0 25px 25px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
        }
        header::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 6px;
            background: linear-gradient(90deg, #009ADA 20%, var(--primary) 50%, var(--accent) 80%);
        }
        .header-logo { height: 50px; width: auto; object-fit: contain; }
        header img.header-logo:first-of-type { height: 38px; }
        .header-title-box { text-align: center; flex: 1; padding: 0 5px; }
        .header-title-box h1 { margin: 0; font-size: 1.8rem; color: var(--primary); font-weight: 900; line-height: 1.1; }
        .header-title-box p { margin: 3px 0 0 0; color: #666; font-size: 0.85rem; font-weight: bold; }

        /* Container & Cards */
        .container { padding: 15px; max-width: 600px; margin: 0 auto; }
        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .card { background: var(--white); border-radius: 20px; padding: 25px 20px; margin-bottom: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); text-align: center; border: 1px solid #eee; }
        .card h2 { margin-top: 0; color: var(--primary); font-size: 1.5rem; font-weight: 900; border-bottom: 3px solid #f0f4f8; padding-bottom: 15px; margin-bottom: 20px; }

        /* Inputs & Buttons UI */
        .input-group { margin-bottom: 25px; text-align: left; }
        .input-group label { display: block; font-size: 1.1rem; color: #444; margin-bottom: 8px; font-weight: 900; }
        
        .select-wrapper { position: relative; width: 100%; }
        select { 
            width: 100%; padding: 18px; border: 2px solid #ccc; border-radius: 15px; 
            font-size: 1.2rem; background: #fff; outline: none; font-weight: bold; color: #222;
            -webkit-appearance: none; appearance: none; cursor: pointer;
        }
        .select-wrapper::after { 
            content: 'â–¼'; position: absolute; right: 20px; top: 50%; transform: translateY(-50%); 
            color: #444; pointer-events: none; font-size: 1.2rem; 
        }
        select:focus { border-color: var(--primary); background: #f9fff9; }
        
        input[type="number"] {
            width: 100%; padding: 18px; border: 2px solid #ccc; border-radius: 15px; 
            font-size: 1.2rem; outline: none; font-weight: bold; color: #222;
        }

        /* æŒ‰éˆ•å¼é¸é … (Pill Buttons) */
        .option-group { display: flex; gap: 10px; width: 100%; }
        .option-btn {
            flex: 1; padding: 15px 5px; 
            border: 2px solid #ddd; border-radius: 15px;
            background: #fff; color: #666;
            font-size: 1.1rem; font-weight: 900;
            text-align: center; cursor: pointer;
            transition: all 0.2s; user-select: none;
            display: flex; align-items: center; justify-content: center;
        }
        .option-btn.active {
            border-color: var(--primary); background-color: #e8f5e9;
            color: var(--primary); box-shadow: 0 4px 10px rgba(0, 144, 69, 0.2);
            transform: scale(1.02);
        }

        /* Buttons (General) */
        .btn { 
            background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; 
            border: none; padding: 18px; width: 100%; border-radius: 18px; 
            font-size: 1.3rem; font-weight: 900; cursor: pointer; 
            box-shadow: 0 6px 15px rgba(0,144,69,0.3); display: flex; align-items: center; justify-content: center; 
            text-decoration: none; margin-bottom: 15px; transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.97); }
        .btn-outline { background: #fff; border: 3px solid var(--primary); color: var(--primary); box-shadow: none; }
        .btn-line { background: #06c755; box-shadow: 0 6px 15px rgba(6,199,85,0.3); }
        .btn-refill { background: linear-gradient(135deg, var(--accent), #e07010); box-shadow: 0 6px 15px rgba(245,130,32,0.3); }
        .btn-next { background: linear-gradient(135deg, var(--accent), #e07010); margin-top: 20px; box-shadow: 0 6px 15px rgba(245,130,32,0.3); }

        /* Risk Matrix */
        .risk-matrix { display: grid; grid-template-columns: 60px 1fr 1fr 1fr; gap: 3px; margin: 25px auto; background: #fff; font-size: 0.9rem; }
        .matrix-cell { display: flex; align-items: center; justify-content: center; text-align: center; padding: 2px; border-radius: 6px; font-weight: bold; color: rgba(0,0,0,0.3); height: 55px; position: relative; }
        .matrix-header { background: #f4f4f4; color: #444; font-weight: 900; font-size: 0.85rem; padding: 5px 0; }
        .matrix-label { background: #f4f4f4; color: #444; font-weight: 900; font-size: 0.8rem; flex-direction: column; justify-content: center; display: flex; align-items: center; }
        .bg-g { background-color: var(--risk-g); } .bg-y { background-color: var(--risk-y); } .bg-o { background-color: var(--risk-o); } .bg-r { background-color: var(--risk-r); }
        .matrix-cell.active-cell { border: 4px solid #0044cc; box-shadow: 0 0 15px rgba(0,68,204,0.6); z-index: 10; transform: scale(1.1); }

        .risk-banner { padding: 20px; margin-top: 25px; border-radius: 15px; color: white; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); animation: fadeIn 0.3s ease; }
        .risk-banner h3 { margin: 0; font-size: 1.8rem; font-weight: 900; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .risk-banner p { margin: 5px 0 0; font-size: 1.1rem; font-weight: bold; opacity: 0.95; }

        /* List Cards */
        .list-card { text-align: left; margin-bottom: 25px; border-radius: 15px; overflow: hidden; border: 2px solid #ddd; }
        .list-head { padding: 18px; font-weight: 900; color: white; font-size: 1.3rem; }
        .list-body { padding: 25px; font-size: 1.15rem; line-height: 1.6; background: #fff; }
        .list-item { margin-bottom: 15px; border-bottom: 2px dashed #ccc; padding-bottom: 15px; }
        .list-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .list-title { font-weight: 900; display: block; color: #000; font-size: 1.25rem; }
        
        /* Nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height); background: white; display: flex; justify-content: space-around; align-items: center; border-top: 2px solid #ccc; z-index: 1000; }
        .nav-item { text-align: center; color: #999; font-size: 0.9rem; flex: 1; padding: 5px; cursor: pointer; font-weight: 900; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active .nav-icon { transform: scale(1.15); color: var(--primary); }
        .nav-icon { font-size: 2rem; display: block; margin-bottom: 4px; }

        .hidden { display: none; }
        .page-counter { text-align: center; font-size: 1.2rem; color: #555; margin: 20px 0; font-weight: 900; }

        /* Quiz */
        .quiz-option { background: #fff; border: 3px solid #eee; border-radius: 15px; padding: 20px; margin-bottom: 15px; font-size: 1.2rem; font-weight: 900; color: #444; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.05); transition: 0.2s; position: relative; text-align: left; }
        .quiz-option:active { transform: scale(0.98); background: #f9f9f9; }
        .quiz-option.correct { border-color: #6bbd45; background: #f0fff4; color: #2e7d32; }
        .quiz-option.correct::after { content: 'âœ…'; position: absolute; right: 20px; top: 50%; transform: translateY(-50%); font-size: 1.5rem; }
        .quiz-option.wrong { border-color: #e03e2e; background: #fff5f5; color: #c62828; }
        .quiz-option.wrong::after { content: 'âŒ'; position: absolute; right: 20px; top: 50%; transform: translateY(-50%); font-size: 1.5rem; }
        .progress-bar { width: 100%; height: 12px; background: #eee; border-radius: 6px; margin-bottom: 20px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }

        /* Others */
        .qr-box { width: 220px; height: 220px; margin: 20px auto; border: 2px solid #eee; border-radius: 20px; }
        .qr-img { width: 100%; height: 100%; object-fit: contain; }
        .traffic-container { display: flex; justify-content: center; gap: 20px; margin: 25px 0; }
        .light { width: 70px; height: 70px; border-radius: 50%; background: #ddd; opacity: 0.2; transition: 0.3s; box-shadow: inset 0 0 10px rgba(0,0,0,0.2); }
        .light.on { opacity: 1; transform: scale(1.1); box-shadow: 0 0 20px currentColor; }
        .med-result-box { background: #e8f5e9; padding: 20px; border-radius: 15px; margin-top: 20px; text-align: left; border-left: 8px solid var(--primary); animation: fadeIn 0.3s ease; }
        .kfre-highlight-label { font-size: 1.1rem; color: #555; font-weight: 900; margin-bottom: 5px; display: block; }
        .kfre-highlight-value { font-size: 2.5rem; font-weight: 900; color: #0277bd; display: block; line-height: 1.2; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        
        /* --- ğŸ® è£å‚™æ¬„ CSS --- */
        .equip-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0; }
        .equip-slot { background: #fff; border: 3px dashed #ccc; border-radius: 15px; padding: 15px 10px; text-align: center; cursor: pointer; transition: all 0.2s; position: relative; user-select: none; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 140px; }
        .equip-slot:active { transform: scale(0.95); }

        /* è£å‚™ç¨€æœ‰åº¦ */
        .slot-legendary { border-color: #FF8C00; background-color: #FFF8E1; } .slot-legendary .equip-name { color: #E65100; }
        .slot-epic { border-color: #9C27B0; background-color: #F3E5F5; } .slot-epic .equip-name { color: #4A148C; }
        .slot-rare { border-color: #2196F3; background-color: #E3F2FD; } .slot-rare .equip-name { color: #0D47A1; }
        .slot-uncommon { border-color: #4CAF50; background-color: #E8F5E9; } .slot-uncommon .equip-name { color: #1B5E20; }
        .slot-arcane { border-color: #00BCD4; background-color: #E0F7FA; } .slot-arcane .equip-name { color: #006064; }

        /* è£å‚™å•Ÿç”¨ç‹€æ…‹ */
        .equip-slot.equipped { border-style: solid; border-width: 4px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); background: #fff; }
        .slot-legendary.equipped { box-shadow: 0 0 15px rgba(255, 140, 0, 0.4); }
        .slot-epic.equipped { box-shadow: 0 0 15px rgba(156, 39, 176, 0.4); }
        .slot-rare.equipped { box-shadow: 0 0 15px rgba(33, 150, 243, 0.4); }
        .slot-uncommon.equipped { box-shadow: 0 0 15px rgba(76, 175, 80, 0.4); }
        .slot-arcane.equipped { box-shadow: 0 0 15px rgba(0, 188, 212, 0.4); }

        .equip-slot.equipped::after { content: 'å·²è£å‚™'; position: absolute; top: -12px; right: -5px; color: white; font-size: 0.8rem; padding: 3px 8px; border-radius: 10px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .slot-legendary.equipped::after { background: #FF8C00; }
        .slot-epic.equipped::after { background: #9C27B0; }
        .slot-rare.equipped::after { background: #2196F3; }
        .slot-uncommon.equipped::after { background: #4CAF50; }
        .slot-arcane.equipped::after { background: #00BCD4; }

        .equip-icon { font-size: 3rem; display: block; margin-bottom: 5px; filter: grayscale(100%); opacity: 0.5; transition: 0.3s; }
        .equip-slot.equipped .equip-icon { filter: grayscale(0%); opacity: 1; transform: scale(1.1); }
        .equip-name { font-size: 1.1rem; font-weight: 900; margin-top: 5px; display: block; }
        .equip-desc { font-size: 0.85rem; color: #666; display: block; margin-top: 2px; }
        .hidden-checkbox { display: none; }
        
        /* ç©å®¶ç‹€æ…‹åˆ— */
        .status-panel { display: flex; align-items: center; padding: 20px; border-radius: 15px; margin-bottom: 30px; color: white; transition: all 0.5s ease; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .status-icon { font-size: 3.5rem; margin-right: 20px; }
        .status-title { font-size: 2rem; font-weight: 900; margin-bottom: 5px; }
        .status-msg { font-size: 1.1rem; opacity: 0.9; }
        .status-novice { background: linear-gradient(135deg, #757F9A, #D7DDE8); color: #333; }
        .status-apprentice { background: linear-gradient(135deg, #11998e, #38ef7d); }
        .status-veteran { background: linear-gradient(135deg, #2193b0, #6dd5ed); }
        .status-elite { background: linear-gradient(135deg, #834d9b, #d04ed6); }
        .status-guardian { background: linear-gradient(135deg, #F2994A, #F2C94C); box-shadow: 0 0 20px #F2C94C; }
        @keyframes pop-effect { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .animate-pop { animation: pop-effect 0.4s ease-out; }
    </style>
</head>
<body>

<header>
    <img src="logo_left.png" alt="è±åŸé†«é™¢" class="header-logo" onerror="this.style.opacity='0.2'">
    <div class="header-title-box">
        <h1>è…åˆ©ç®¡å®¶</h1>
        <p>æ‚¨çš„å°ˆå±¬è­·è…å°å¹«æ‰‹</p>
    </div>
    <img src="logo_right_new.png" alt="äº”ç¦è—¥å¸«åœˆ" class="header-logo" onerror="this.style.opacity='0.2'">
</header>

<div class="container">

    <div id="tab-home" class="section active">
        <div class="card" style="border-top: 5px solid #29b6f6;">
            <h2 style="color:#0277bd; border-bottom-color:#e1f5fe;">ğŸ“Š è…è‡Ÿé¢¨éšªè©•ä¼°èˆ‡é æ¸¬</h2>
            <p style="color:#666; font-size:0.95rem; margin-bottom:20px; text-align:left; padding:0 10px;">
                è«‹è¼¸å…¥ä»¥ä¸‹è³‡æ–™ï¼Œç³»çµ±å°‡è‡ªå‹•è¨ˆç®—æ‚¨çš„è…è‡Ÿç—…åˆ†æœŸä»¥åŠæœªä¾†æ´—è…é¢¨éšªã€‚
            </p>

            <div class="input-group"><label>1. å¹´é½¡</label><div class="select-wrapper">
                <select id="kfre-age" onchange="updateAllRisks()">
                    <option value="" disabled selected>è«‹é¸æ“‡å¹´é½¡...</option><option value="20">20-29 æ­²</option><option value="30">30-39 æ­²</option><option value="40">40-49 æ­²</option><option value="50">50-59 æ­²</option><option value="60">60-69 æ­²</option><option value="70">70-79 æ­²</option><option value="80">80-89 æ­²</option><option value="90">90 æ­²ä»¥ä¸Š</option>
                </select>
            </div></div>

            <div class="input-group"><label>2. æ€§åˆ¥</label>
                <div class="option-group" id="group-sex">
                    <div class="option-btn" onclick="setOption('kfre-sex', '1', this)">ç”·</div>
                    <div class="option-btn" onclick="setOption('kfre-sex', '0', this)">å¥³</div>
                </div>
                <input type="hidden" id="kfre-sex" onchange="updateAllRisks()">
            </div>
            
            <div class="input-group"><label>3. é«”é‡ (å…¬æ–¤)</label><input type="number" id="kfre-weight" placeholder="è«‹è¼¸å…¥é«”é‡..." onchange="updateAllRisks()"></div>

            <div class="input-group"><label>4. è…åŠŸèƒ½ (eGFR)</label><div class="select-wrapper">
                <select id="kfre-egfr" onchange="updateAllRisks()">
                    <option value="" disabled selected>è«‹é¸æ“‡æ•¸å€¼å€é–“...</option><option value="90">æ­£å¸¸ (eGFR â‰¥ 90)</option><option value="75">ç¬¬2æœŸ (eGFR 60-89)</option><option value="52">ç¬¬3aæœŸ (eGFR 45-59)</option><option value="37">ç¬¬3bæœŸ (eGFR 30-44)</option><option value="22">ç¬¬4æœŸ (eGFR 15-29)</option><option value="10">ç¬¬5æœŸ (eGFR < 15)</option>
                </select>
            </div></div>

            <div class="input-group"><label>5. è›‹ç™½å°¿ç‹€æ³ (UACR)</label>
                <div class="option-group" id="group-uacr">
                    <div class="option-btn active" onclick="setOption('kfre-uacr', '10', this)">æ­£å¸¸<br>&lt;30</div>
                    <div class="option-btn" onclick="setOption('kfre-uacr', '150', this)">å¾®é‡<br>30-300</div>
                    <div class="option-btn" onclick="setOption('kfre-uacr', '500', this)">åš´é‡<br>&gt;300</div>
                </div>
                <input type="hidden" id="kfre-uacr" value="10" onchange="updateAllRisks()">
            </div>

            <div class="input-group"><label>6. æ˜¯å¦æœ‰ç³–å°¿ç—… (DM)</label>
                <div class="option-group" id="group-dm">
                    <div class="option-btn active" onclick="setOption('kfre-dm', '0', this)">ç„¡</div>
                    <div class="option-btn" onclick="setOption('kfre-dm', '1', this)">æœ‰</div>
                </div>
                <input type="hidden" id="kfre-dm" value="0" onchange="updateAllRisks()">
            </div>

            <p id="start-hint" style="color:#888; font-size:1.1rem; margin-top:20px; font-weight:bold;">ğŸ‘† è³‡æ–™å¡«å¯«å®Œæ•´å¾Œï¼Œçµæœå°‡è‡ªå‹•é¡¯ç¤º</p>

            <div id="unified-result" class="hidden">
                <div id="risk-banner" class="risk-banner" style="background:#ccc; margin-bottom:20px;">
                    <h3 id="risk-title" style="margin-bottom:5px;">--</h3><p id="risk-desc" style="font-size:1rem;">--</p>
                </div>
                <div class="risk-matrix">
                    <div class="matrix-header"></div><div class="matrix-header">æ­£å¸¸<br><30</div><div class="matrix-header">å¾®é‡<br>30-299</div><div class="matrix-header">åš´é‡<br>>300</div>
                    <div class="matrix-label">ç¬¬1æœŸ<br>>90</div><div class="matrix-cell bg-g" id="cell-1-1"></div><div class="matrix-cell bg-g" id="cell-1-2"></div><div class="matrix-cell bg-o" id="cell-1-3"></div>
                    <div class="matrix-label">ç¬¬2æœŸ<br>60-89</div><div class="matrix-cell bg-g" id="cell-2-1"></div><div class="matrix-cell bg-g" id="cell-2-2"></div><div class="matrix-cell bg-o" id="cell-2-3"></div>
                    <div class="matrix-label">ç¬¬3a<br>45-59</div><div class="matrix-cell bg-y" id="cell-3a-1"></div><div class="matrix-cell bg-o" id="cell-3a-2"></div><div class="matrix-cell bg-r" id="cell-3a-3"></div>
                    <div class="matrix-label">ç¬¬3b<br>30-44</div><div class="matrix-cell bg-o" id="cell-3b-1"></div><div class="matrix-cell bg-r" id="cell-3b-2"></div><div class="matrix-cell bg-r" id="cell-3b-3"></div>
                    <div class="matrix-label">ç¬¬4æœŸ<br>15-29</div><div class="matrix-cell bg-r" id="cell-4-1"></div><div class="matrix-cell bg-r" id="cell-4-2"></div><div class="matrix-cell bg-r" id="cell-4-3"></div>
                    <div class="matrix-label">ç¬¬5æœŸ<br><15</div><div class="matrix-cell bg-r" id="cell-5-1"></div><div class="matrix-cell bg-r" id="cell-5-2"></div><div class="matrix-cell bg-r" id="cell-5-3"></div>
                </div>
                <div style="background:#e1f5fe; border-radius:15px; padding:25px 15px; border:2px solid #b3e5fc; text-align:center; margin-top:25px;">
                    <h3 style="margin:0 0 20px 0; color:#01579b; font-size:1.5rem;">ğŸ“… æœªä¾†æ´—è…æ©Ÿç‡é æ¸¬</h3>
                    <div style="display:flex; justify-content:space-around; margin-bottom:20px; align-items: flex-start;">
                        <div style="flex:1;"><span class="kfre-highlight-label">2å¹´å…§æ´—è…æ©Ÿç‡</span><span id="res-2yr" class="kfre-highlight-value">--%</span></div>
                        <div style="width:2px; background:#81d4fa; height:60px; margin-top:10px;"></div>
                        <div style="flex:1;"><span class="kfre-highlight-label">5å¹´å…§æ´—è…æ©Ÿç‡</span><span id="res-5yr" class="kfre-highlight-value">--%</span></div>
                    </div>
                    <div id="kfre-advice-box" style="background:white; padding:15px; border-radius:10px; text-align:left; font-size:1.1rem; line-height:1.6; border-left:6px solid #ccc; box-shadow:0 2px 5px rgba(0,0,0,0.05);">å»ºè­°è¼‰å…¥ä¸­...</div>
                </div>
                <p style="color:#d32f2f; font-weight:900; margin-top:25px; font-size:1.1rem;">ğŸ‘‡ æ‚¨çš„å°ˆå±¬ç”¨è—¥èˆ‡é£²é£Ÿå»ºè­°å·²ç”Ÿæˆï¼Œ<br>è«‹é»é¸ä¸‹æ–¹é¸å–®åˆ‡æ›æŸ¥çœ‹ã€‚</p>
            </div>
        </div>
        <div class="page-counter">ğŸ‘€ æœ¬ç«™ç´¯è¨ˆç€è¦½ï¼š<span id="busuanzi_value_site_pv">--</span> äººæ¬¡</div>
    </div>

    <div id="tab-meds" class="section">
        <div class="card">
            <h2>ğŸ’Š å€‹äººåŒ–ç”¨è—¥å»ºè­°</h2>
            <div id="med-placeholder" style="padding:40px 10px; color:#999;">
                <div style="font-size:4rem;">ğŸ“‰</div><p style="font-size:1.3rem;">è«‹å…ˆè‡³ã€Œé¦–é ã€é¸æ“‡è…åŠŸèƒ½<br>ç³»çµ±å°‡è‡ªå‹•ç”¢ç”Ÿå»ºè­°</p>
                <button class="btn btn-outline" onclick="switchTab('home')">å‰å¾€é¦–é </button>
            </div>
            <div id="med-content" class="hidden">
                <p style="background:#eee; padding:15px; border-radius:15px; color:#444; font-weight:bold;">ä¾æ“šæ‚¨çš„ <strong>eGFR <span id="med-egfr-val" style="color:var(--primary);">--</span></strong> åˆ†æï¼š</p>
                <div class="list-card" style="border-color: var(--risk-g);"><div class="list-head" style="background: var(--risk-g);">ğŸŸ¢ å»ºè­°ç”¨è—¥ (æ”¾å¿ƒä½¿ç”¨)</div><div class="list-body" id="list-med-g"></div></div>
                <div class="list-card" style="border-color: var(--risk-y);"><div class="list-head" style="background: var(--risk-y); color:#333;">ğŸŸ¡ é ˆæ³¨æ„ (å°å¿ƒå‰¯ä½œç”¨)</div><div class="list-body" id="list-med-y"></div></div>
                <div class="list-card" style="border-color: var(--risk-r);"><div class="list-head" style="background: var(--risk-r);">ğŸ”´ ä¸å»ºè­°æœç”¨ (å‚·è…)</div><div class="list-body" id="list-med-r"></div></div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸš¦ è—¥ç‰©å®‰å…¨ç´…ç¶ ç‡ˆ</h2>
            <div class="select-wrapper">
                <select id="med-select" onchange="checkMed()">
                    <option value="">ğŸ” è«‹é¸æ“‡è—¥ç‰©åç¨±...</option><option value="ras">ACEi / ARB (è¡€å£“è—¥)</option><option value="panadol">Acetaminophen (æ™®æ‹¿ç–¼)</option><option value="mycin">Aminoglycosides (éƒ¨åˆ†æŠ—ç”Ÿç´ )</option><option value="antacid">Antacids (å«é‹é‚èƒƒè—¥)</option><option value="contrast">Contrast Media (å«ç¢˜é¡¯å½±åŠ‘)</option><option value="diuretic">Diuretics (åˆ©å°¿åŠ‘)</option><option value="enema">Enema (æ¸…è…¸åŠ‘)</option><option value="ns_mra">Finerenone (ns-MRA)</option><option value="glp1">GLP-1 RA (è…¸æ³Œç´ é‡åŠ‘)</option><option value="herbal">Herbal (ä¸­è‰è—¥/é»‘è—¥ä¸¸)</option><option value="metformin">Metformin (äºŒç”²é›™èƒé™ç³–è—¥)</option><option value="multi_vit">Multivitamins (ç¶œåˆç¶­ä»–å‘½)</option><option value="nsaid">NSAIDs (å¼·æ•ˆæ­¢ç—›è—¥)</option><option value="gout_nsaid">NSAIDs (ç—›é¢¨ç™¼ä½œæ™‚)</option><option value="ppi">PPIs (è³ªå­å¹«æµ¦æŠ‘åˆ¶åŠ‘èƒƒè—¥)</option><option value="probiotic">Probiotics (è…è‡Ÿç›Šç”ŸèŒ)</option><option value="sglt2">SGLT2i (æ’ç³–è—¥)</option><option value="statins">Statins (é™è¡€è„‚è—¥)</option><option value="uric_acid">Uric Acid Meds (é™å°¿é…¸è—¥)</option><option value="vaccine">Vaccines (ç–«è‹—)</option><option value="vit_d">Vitamin D (æ´»æ€§ç¶­ç”Ÿç´ D)</option>
                </select>
            </div>
            <div class="traffic-container">
                <div id="light-r" class="light" style="color: var(--risk-r); background: var(--risk-r);"></div><div id="light-y" class="light" style="color: var(--risk-y); background: var(--risk-y);"></div><div id="light-g" class="light" style="color: var(--risk-g); background: var(--risk-g);"></div>
            </div>
            <div id="med-result" class="med-result-box hidden"></div>
        </div>
        
        <div class="card" style="border: 3px solid #ff9800; background: #fff3e0;">
            <h2 style="color:#e65100; border-bottom-color:#ffcc80; margin-bottom:15px;">ğŸ¤¢ ç”Ÿç—…æ—¥åœè—¥å®ˆå‰‡</h2>
            <div style="background:white; border-radius:15px; padding:15px; margin-bottom:20px; border:2px dashed #ffb74d;"><p style="font-size:0.9rem; color:#e65100; margin:5px 0 0 0; font-weight:bold;">å£è¨£ï¼šSADMANS (æ‚²å‚·ç”·äºº)</p></div>
            <p style="text-align:left; font-weight:bold; color:#bf360c; line-height:1.6; margin-bottom:20px;">ç•¶æ‚¨ç™¼ç”Ÿ<span style="background:#ffccbc; padding:2px 5px; border-radius:5px;">åš´é‡è„«æ°´</span>æƒ…æ³æ™‚ï¼Œè«‹æš«åœä»¥ä¸‹è—¥ç‰©ï¼š</p>
            <div style="text-align:left; display:grid; grid-template-columns: 1fr; gap:10px;">
                <div class="quiz-option" style="margin:0; padding:12px; font-size:1.1rem; border-color:#ffcc80; color:#e65100;">ğŸ’Š <strong>S</strong>ulfonylureas (é™ç³–è—¥)</div><div class="quiz-option" style="margin:0; padding:12px; font-size:1.1rem; border-color:#ffcc80; color:#e65100;">ğŸ’Š <strong>A</strong>CEi (è¡€å£“è—¥)</div><div class="quiz-option" style="margin:0; padding:12px; font-size:1.1rem; border-color:#ffcc80; color:#e65100;">ğŸ’Š <strong>D</strong>iuretics (åˆ©å°¿åŠ‘)</div><div class="quiz-option" style="margin:0; padding:12px; font-size:1.1rem; border-color:#ffcc80; color:#e65100;">ğŸ’Š <strong>M</strong>etformin (é™ç³–è—¥)</div><div class="quiz-option" style="margin:0; padding:12px; font-size:1.1rem; border-color:#ffcc80; color:#e65100;">ğŸ’Š <strong>A</strong>RBs (è¡€å£“è—¥)</div><div class="quiz-option" style="margin:0; padding:12px; font-size:1.1rem; border-color:#ffcc80; color:#e65100;">ğŸ’Š <strong>N</strong>SAIDs (æ­¢ç—›è—¥)</div><div class="quiz-option" style="margin:0; padding:12px; font-size:1.1rem; border-color:#ffcc80; color:#e65100;">ğŸ’Š <strong>S</strong>GLT2i (æ’ç³–è—¥)</div>
            </div>
        </div>
        
        <div class="card">
            <h2>ğŸ” ä¸æ¸…æ¥šè‡ªå·±ç”¨ä»€éº¼è—¥ï¼Ÿ</h2>
            <div style="display:flex; gap:15px;"><button class="btn" style="margin:0; flex:1;" onclick="switchTab('consult')">ğŸ’¬ è«®è©¢è—¥å¸«</button><a href="https://www.fyh.mohw.gov.tw/?aid=519" target="_blank" class="btn btn-outline" style="margin:0; flex:1; display:flex; align-items:center; justify-content:center;">ğŸ¥ è—¥å“æŸ¥è©¢</a></div>
        </div>
    </div>

    <div id="tab-diet" class="section">
        <div class="card">
            <h2>ğŸ½ï¸ å€‹äººåŒ–é£²é£Ÿå»ºè­°</h2>
            <div id="diet-placeholder" style="padding:40px 10px; color:#999;"><div style="font-size:4rem;">ğŸ¥£</div><p style="font-size:1.3rem;">è«‹å…ˆè‡³ã€Œé¦–é ã€é¸æ“‡è…åŠŸèƒ½<br>ä»¥å–å¾—å°ˆå±¬é£²é£Ÿæ¸…å–®</p><button class="btn btn-outline" onclick="switchTab('home')">å‰å¾€é¦–é </button></div>
            <div id="diet-content" class="hidden">
                <div class="list-card" style="border-color: var(--risk-g);"><div class="list-head" style="background: var(--risk-g);">ğŸŸ¢ å»ºè­°æ”å–</div>
                    <div id="protein-calc-display" style="margin: 10px; padding: 12px; background-color: #f0fdf4; border: 1px dashed #16a34a; border-radius: 8px; display: none;">
                        <p style="margin: 0; font-size: 1.1rem; color: #374151;">é«”é‡ <span id="display-weight" style="font-weight: bold;">--</span> kgï¼Œå»ºè­°æ¯æ—¥è›‹ç™½è³ªï¼š</p>
                        <div style="display: flex; align-items: baseline; margin-top: 5px;"><span id="display-protein-min" style="font-size: 1.6rem; font-weight: bold; color: #16a34a;">--</span><span style="margin: 0 5px;">~</span><span id="display-protein-max" style="font-size: 1.6rem; font-weight: bold; color: #16a34a;">--</span><span style="margin-left: 5px; font-size: 1rem;">å…‹</span></div><p style="margin: 5px 0 0 0; font-size: 1rem; color: #6b7280;">(ç´„ <span id="display-protein-portions" style="font-weight: bold; color: #059669;">--</span> ä»½è±†é­šè›‹è‚‰é¡)</p>
                    </div>
                    <div class="list-body" id="list-diet-g"></div>
                </div>
                <div class="list-card" style="border-color: var(--risk-y);"><div class="list-head" style="background: var(--risk-y); color:#333;">ğŸŸ¡ é ˆæ³¨æ„/æ¸›é‡</div><div class="list-body" id="list-diet-y"></div></div>
                <div class="list-card" style="border-color: var(--risk-r);"><div class="list-head" style="background: var(--risk-r);">ğŸ”´ ä¸å»ºè­°æ”å–</div><div class="list-body" id="list-diet-r"></div></div>
            </div>

            <div style="margin: 40px 0 20px 0; text-align: center; border-top: 3px solid #f0f4f8; padding-top: 30px;">
                <h3 style="color: var(--primary); font-size: 1.5rem; font-weight: 900; margin: 0 0 20px 0;">ğŸ½ï¸ è­·è…é¤ç›¤</h3>
                <img src="kidney_plate_new.jpg" alt="è­·è…é¤ç›¤" style="width: 100%; max-width: 400px; height: auto; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); border: 3px solid #eee;">
                <p style="color:#666; font-size:0.95rem; margin-top:10px;">(å£è¨£ï¼šä¸€ç¢—åŠè”¬èœã€é©é‡é­šè‚‰è±†è›‹ã€å°‘è¨±ä½æ°®æ¾±ç²‰)</p>
            </div>
            <hr style="margin: 30px 0; border:0; border-top:2px dashed #ddd;">
            <h3 style="color:var(--primary); margin-bottom:15px;">ğŸ” å–®é …é£Ÿç‰©æŸ¥è©¢</h3>
            <div class="select-wrapper">
                <select id="food-select" onchange="checkFood()">
                    <option value="">è«‹é»æ­¤é¸æ“‡é£Ÿç‰©...</option>
                    <optgroup label="å¸¸è¦‹é£Ÿæ"><option value="egg">é›è›‹ç™½</option><option value="tofu">å«©è±†è…</option><option value="rice_noodle">å†¬ç²‰/ç±³ç²‰</option><option value="rice">ç™½é£¯</option><option value="veg">é«˜éº—èœ/æ´‹è”¥</option><option value="fruit_low">è˜‹æœ/é³³æ¢¨</option><option value="oil">æ©„æ¬–æ²¹/è‹¦èŒ¶æ²¹</option><option value="spinach">è èœ/åœ°ç“œè‘‰</option><option value="brown_rice">ç³™ç±³/äº”ç©€ç±³</option><option value="nuts">å …æœ</option><option value="coffee">é»‘å’–å•¡</option><option value="banana">é¦™è•‰</option><option value="starfruit">æ¥Šæ¡ƒ</option><option value="sausage">é¦™è…¸/ç«è…¿</option><option value="organs">å…§è‡Ÿ(è±¬è‚)</option><option value="cola">å¯æ¨‚/æ±½æ°´</option><option value="chicken">é›ç²¾</option></optgroup>
                </select>
            </div>
            <div id="food-result" class="med-result-box hidden"></div>
        </div>
    </div>

    <div id="tab-quiz" class="section">
        <div class="card" style="border: 3px solid #6bbd45; background: #fff;">
            <h2 style="color:#2e7d32; border-bottom-color:#a5d6a7;">ğŸ›¡ï¸ è­·è…è£å‚™åº«</h2>
            <p style="text-align:center; color:#666; font-size:1rem; margin-bottom:15px;">é»æ“Šæ–¹å¡Šã€Œç©¿æˆ´ã€æ‚¨æ­£åœ¨ä½¿ç”¨çš„è—¥ç‰©<br>ç¨±è™Ÿèˆ‡å»ºè­°å°‡æœƒå³æ™‚æ›´æ–°ï¼</p>

            <div class="equip-grid">
                <div class="equip-slot slot-legendary" onclick="toggleEquip(this, 'drug-sglt2')">
                    <span class="equip-icon">ğŸ›¡ï¸</span><span class="equip-name">æ’ç³–è—¥</span><span class="equip-desc">æ ¸å¿ƒç¥å™¨ SGLT2i</span><input type="checkbox" id="drug-sglt2" class="gear-checkbox hidden-checkbox">
                </div>
                <div class="equip-slot slot-epic" onclick="toggleEquip(this, 'drug-rasi')">
                    <span class="equip-icon">ğŸ§¥</span><span class="equip-name">è¡€å£“è—¥</span><span class="equip-desc">åŸºç¤é§ç”² ACEi/ARB</span><input type="checkbox" id="drug-rasi" class="gear-checkbox hidden-checkbox">
                </div>
                <div id="slot-nsmra" class="equip-slot slot-rare" onclick="toggleEquip(this, 'drug-nsmra')">
                    <span class="equip-icon">ğŸ”®</span><span class="equip-name">æ–°å‹è­·è…è—¥</span><span class="equip-desc">é«˜éšå¼·åŒ– ns-MRA</span><input type="checkbox" id="drug-nsmra" class="gear-checkbox hidden-checkbox">
                </div>
                <div class="equip-slot slot-uncommon" onclick="toggleEquip(this, 'drug-statin')">
                    <span class="equip-icon">ğŸ‘¢</span><span class="equip-name">é™è¡€è„‚è—¥</span><span class="equip-desc">ç–¾é¢¨ä¹‹é´ Statins</span><input type="checkbox" id="drug-statin" class="gear-checkbox hidden-checkbox">
                </div>
                <div id="slot-glp1" class="equip-slot slot-arcane" onclick="toggleEquip(this, 'drug-glp1')">
                    <span class="equip-icon">ğŸª„</span><span class="equip-name">è…¸æ³Œç´ </span><span class="equip-desc">æ§ç³–é­”æ– GLP-1 RA</span><input type="checkbox" id="drug-glp1" class="gear-checkbox hidden-checkbox">
                </div>
            </div>

            <div id="status-panel" class="status-panel status-novice" style="margin-top: 20px;">
                <div class="status-icon" id="status-icon">âš ï¸</div>
                <div class="status-info"><div class="status-label">ç›®å‰ç¨±è™Ÿ</div><div class="status-title" id="status-title">æ–°æ‰‹å†’éšªè€…</div><div class="status-msg" id="status-msg">å“å‘€ï¼æ‚¨çš„è…è‡Ÿç›®å‰å®Œå…¨æ²’æœ‰é˜²è­·ï¼Œé¢¨éšªæ¥µé«˜ï¼</div></div>
            </div>
            <div id="dynamic-advice" class="hidden" style="margin-top:15px; text-align:left; animation: fadeIn 0.5s;"></div>
        </div>

        <div class="card">
            <h2>ğŸ“ è…åˆ©å¤§æœƒè€ƒ</h2>
            <div class="progress-bar"><div id="quiz-progress" class="progress-fill"></div></div>
            <p id="quiz-counter" style="text-align:right; color:#666; font-size:1.1rem; font-weight:bold;">Q1/10</p>
            <div id="quiz-area"><h3 id="quiz-question" style="min-height:70px; font-size:1.4rem;">è¼‰å…¥ä¸­...</h3><div id="quiz-options"></div></div>
            <div id="quiz-feedback" class="hidden" style="margin-top:25px;">
                <div id="quiz-res-text" style="font-size:1.6rem; font-weight:900; margin-bottom:15px;"></div><div id="quiz-exp" style="background:#fff; padding:20px; border-radius:15px; border:2px solid #ccc; color:#444; font-size:1.2rem;"></div><button class="btn btn-next" onclick="nextQ()">ä¸‹ä¸€é¡Œ âœ</button>
            </div>
            <div id="quiz-score" class="hidden"><h3 style="font-size:3rem; color:var(--primary);">å¾—åˆ†ï¼š<span id="final-score">0</span></h3><p id="score-comment" style="font-size:1.4rem; font-weight:900; color:#555;"></p><button class="btn" onclick="initQuiz()">ğŸ”„ å†æ¸¬ä¸€æ¬¡</button></div>
        </div>
    </div>

    <div id="tab-consult" class="section">
        <div class="card">
            <h2>ğŸ’¬ è—¥å¸«è«®è©¢å®¤</h2>
            <div style="background:#f9f9f9; padding:25px; border-radius:20px; border:3px solid #eee; margin-bottom:30px;">
                <h3 style="color:#06c755; margin-top:0; display:flex; align-items:center; justify-content:center; gap:10px;"><span style="font-size:2rem;">LINE</span> å®˜æ–¹å¸³è™Ÿ</h3>
                <div class="qr-box"><img src="line_qr.png" class="qr-img" onerror="this.style.display='none'"></div>
                <p style="font-size:1.1rem; color:#666; font-weight:bold; margin-bottom:20px;">(é•·æŒ‰å„²å­˜æˆ–æƒæä¸Šæ–¹ QR Code)</p><a href="https://lin.ee/zwLjX1Lb" target="_blank" class="btn btn-line">ğŸ“² åŠ å…¥å¥½å‹ (ç·šä¸Šè«®è©¢)</a>
            </div>
            <div style="background:#fff8e1; padding:25px; border-radius:20px; border:3px solid #ffe0b2;">
                <h3 style="color:var(--accent); margin-top:0; font-size:1.6rem;">æ…¢ç®‹é ç´„</h3><p style="font-weight:bold; color:#555; font-size:1.2rem;">ä¸ç”¨æ’éšŠï¼Œæ‰‹æ©Ÿé ç´„é ˜è—¥</p><a href="https://nreg.fyh.mohw.gov.tw/OReg/HomePage?page=ChronicRegisterPage#" target="_blank" class="btn btn-refill">å‰å¾€é ç´„ âœ</a>
            </div>
        </div>
    </div>

</div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('home')"><span class="nav-icon">ğŸ </span>é¦–é </div>
    <div class="nav-item" onclick="switchTab('meds')"><span class="nav-icon">ğŸ’Š</span>ç”¨è—¥</div>
    <div class="nav-item" onclick="switchTab('diet')"><span class="nav-icon">ğŸ¥¦</span>é£²é£Ÿ</div>
    <div class="nav-item" onclick="switchTab('quiz')"><span class="nav-icon">ğŸ“</span>æ¸¬é©—</div>
    <div class="nav-item" onclick="switchTab('consult')"><span class="nav-icon">ğŸ’¬</span>è«®è©¢</div>
</nav>

<script>
    // --- ğŸ”Š Audio ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(isCorrect) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        if (isCorrect) {
            osc.type = 'sine'; osc.frequency.setValueAtTime(500, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            osc.start(); osc.stop(audioCtx.currentTime + 0.5);
        } else {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            osc.start(); osc.stop(audioCtx.currentTime + 0.3);
        }
    }

    // --- Helper: æŒ‰éˆ•åˆ‡æ›é¸é … ---
    function setOption(inputId, value, btnElement) {
        document.getElementById(inputId).value = value;
        updateAllRisks();
        const group = btnElement.parentElement;
        group.querySelectorAll('.option-btn').forEach(b => b.classList.remove('active'));
        btnElement.classList.add('active');
    }

    // --- DB ---
    const medDB = {
        'ras': { level: 'g', title: 'âœ… åŸºç¤è­·è… (ACEi/ARB)', desc: 'æŠ—è›‹ç™½å°¿é¦–é¸è¡€å£“è—¥ã€‚å‰›ä½¿ç”¨ eGFR å¾®é™ 30% å…§å±¬æ­£å¸¸ï¼Œä¸éœ€åœè—¥ã€‚' },
        'panadol': { level: 'g', title: 'âœ… ç›¸å°å®‰å…¨ (Acetaminophen)', desc: 'æ™®æ‹¿ç–¼æˆåˆ†ã€‚åœ¨å®‰å…¨åŠ‘é‡ä¸‹ä¸å‚·è…ï¼Œæ˜¯è…å‹æ­¢ç—›é€€ç‡’é¦–é¸ã€‚' },
        'mycin': { level: 'r', title: 'âš ï¸ é«˜é¢¨éšª (Aminoglycosides)', desc: 'éƒ¨åˆ†æŠ—ç”Ÿç´ å…·è…æ¯’æ€§ï¼Œçœ‹è¨ºæ™‚è«‹å‹™å¿…ä¸»å‹•å‘ŠçŸ¥é†«å¸«è…åŠŸèƒ½ã€‚' },
        'antacid': { level: 'y', title: 'ğŸŸ¡ éœ€æ³¨æ„ (Antacids)', desc: 'é¿å…é•·æœŸæœç”¨å«ã€Œé‹ã€æˆ–ã€Œé‚ã€çš„åˆ¶é…¸èƒƒè—¥ï¼Œè…è‡Ÿç„¡æ³•ä»£è¬æå°è‡´ä¸­æ¯’ã€‚' },
        'contrast': { level: 'r', title: 'âš ï¸ é«˜é¢¨éšª (Contrast Media)', desc: 'å«ç¢˜é¡¯å½±åŠ‘ã€‚eGFR<30 æˆ–æ€¥æ€§æœŸé«˜é¢¨éšªã€‚æª¢æŸ¥å‰å¾Œéœ€è£œå……è¶³å¤ æ°´åˆ†ã€‚' },
        'diuretic': { level: 'y', title: 'ğŸŸ¡ éœ€æ³¨æ„ (Diuretics)', desc: 'åˆ©å°¿åŠ‘ã€‚æœ‰åŠ©æ¶ˆæ°´è…«ï¼Œä½†è‹¥ç™¼ç‡’ã€è…¹ç€‰ã€å˜”å (Sick Day) æ™‚éœ€æš«åœä»¥é˜²è„«æ°´ã€‚' },
        'enema': { level: 'y', title: 'ğŸŸ¡ éœ€å‘ŠçŸ¥ (Enema)', desc: 'å«ç£·é…¸éˆ‰çš„æ¸…è…¸åŠ‘å¯èƒ½é€ æˆæ€¥æ€§ç£·è…ç—…è®Šï¼Œè«‹å‘ŠçŸ¥é†«å¸«è…ç—…å²ã€‚' },
        'glp1': { level: 'g', title: 'âœ… æ§ç³–è­·å¿ƒ (GLP-1 RA)', desc: 'è…¸æ³Œç´ é‡åŠ‘ã€‚é‡å° T2D åˆä½µ CKDï¼Œè‹¥è¡€ç³–æœªé”æ¨™ï¼Œæ¨è–¦å„ªå…ˆä½¿ç”¨å…·å¿ƒè¡€ç®¡å¯¦è­‰çš„è—¥ç‰©ã€‚' },
        'herbal': { level: 'r', title: 'ğŸ›‘ çµ•å°ç¦æ­¢ (Herbal Meds)', desc: 'ä¾†è·¯ä¸æ˜ä¸­è‰è—¥/é»‘è—¥ä¸¸ã€‚å¯èƒ½å«é¦¬å…œéˆ´é…¸æˆ–é‡é‡‘å±¬ï¼Œå…·é«˜åº¦è…æ¯’æ€§ã€‚' },
        'metformin': { level: 'y', title: 'ğŸŸ¡ éœ€æ¸›é‡ (Metformin)', desc: 'é™ç³–è—¥ã€‚eGFR < 30 å¿…é ˆåœç”¨ï¼›30-45 éœ€æ¸›é‡ã€‚æ³¨æ„ä¹³é…¸ä¸­æ¯’é¢¨éšªã€‚' },
        'multi_vit': { level: 'y', title: 'ğŸŸ¡ éœ€æŒ‘é¸ (Multivitamins)', desc: 'å¸‚å”®ç¶œåˆç¶­ä»–å‘½å¯èƒ½å«é«˜ç£·ã€é«˜é‰€ã€‚é€æç—…æ‚£å»ºè­°è£œå……å°ˆç”¨æ°´æº¶æ€§ B ç¾¤ã€‚' },
        'nsaid': { level: 'r', title: 'ğŸ›‘ çµ•å°ç¦æ­¢ (NSAIDs)', desc: 'å¼·æ•ˆæ­¢ç—›è—¥ã€‚æœ€å¼·çƒˆçš„è…è‡Ÿæ®ºæ‰‹ï¼æœƒæ”¶ç¸®å…¥çƒå°å‹•è„ˆï¼Œæ¥µæ˜“é€ æˆæ€¥æ€§è…æå‚·ã€‚' },
        'gout_nsaid': { level: 'r', title: 'ğŸ›‘ ç—›é¢¨æ€¥æ€§æœŸ (Avoid NSAIDs)', desc: 'ç—›é¢¨ç™¼ä½œè«‹é¿å…åƒå¼·æ•ˆæ­¢ç—›è—¥(NSAID)ï¼Œæ‡‰å„ªå…ˆè«®è©¢é†«å¸«ä½¿ç”¨ç§‹æ°´ä»™ç´ æˆ–é¡å›ºé†‡ã€‚' },
        'ns_mra': { level: 'g', title: 'âœ… é€²éšè­·è… (ns-MRA)', desc: 'Finerenoneã€‚é‡å°ç³–å°¿ç—…è…ç—…è®Šä¸”ä»æœ‰è›‹ç™½å°¿è€…ï¼Œå¯æŠ—ç™¼ç‚æŠ—çº–ç¶­åŒ–ã€‚' },
        'ppi': { level: 'y', title: 'ğŸŸ¡ éœ€è©•ä¼° (PPIs)', desc: 'ç‰¹å®šèƒƒè—¥ã€‚é•·æœŸä½¿ç”¨å¯èƒ½å¢åŠ æ…¢æ€§è…ç—…é€²å±•é¢¨éšªï¼Œæ‡‰å®šæœŸè©•ä¼°æ˜¯å¦éœ€çºŒç”¨ã€‚' },
        'probiotic': { level: 'g', title: 'âœ… è¼”åŠ©æ¨è–¦ (Probiotics)', desc: 'è…è‡Ÿå°ˆç”¨ç›Šç”ŸèŒã€‚éƒ¨åˆ†ç‰¹å®šèŒæ ªè­‰å¯¦æœ‰åŠ©æ¸›å°‘è…¸é“å°¿æ¯’ç´ å‰é©…ç‰©ã€‚' },
        'sglt2': { level: 'g', title: 'âœ… æ ¸å¿ƒè­·è… (SGLT2i)', desc: 'æ’ç³–è—¥ã€‚eGFRâ‰§20å³å¯ä½¿ç”¨ï¼Œèƒ½é¡¯è‘—å»¶ç·©æ´—è…ã€ä¿è­·å¿ƒè‡Ÿã€‚ç”Ÿç—…è„«æ°´æ™‚éœ€æš«åœã€‚' },
        'statins': { level: 'g', title: 'âœ… å»ºè­°ä½¿ç”¨ (Statins)', desc: 'é™è¡€è„‚è—¥ã€‚é é˜²ä¸­é¢¨èˆ‡å¿ƒè¡€ç®¡äº‹ä»¶ï¼Œå»ºè­°æŒçºŒæœç”¨ã€‚' },
        'uric_acid': { level: 'y', title: 'ğŸŸ¡ ç„¡ç—‡ç‹€é«˜å°¿é…¸ (Uric Acid)', desc: 'è‹¥ç„¡ç—›é¢¨ç™¼ä½œï¼Œä¸å»ºè­°ç‚ºäº†ã€Œå»¶ç·©è…åŠŸèƒ½æƒ¡åŒ–ã€è€Œå–®ç´”æœç”¨é™å°¿é…¸è—¥ç‰©ã€‚' },
        'vaccine': { level: 'g', title: 'âœ… å»ºè­°æ–½æ‰“ (Vaccines)', desc: 'æµæ„Ÿèˆ‡è‚ºç‚éˆçƒèŒç–«è‹—ã€‚æ¸›å°‘å› åš´é‡æ„ŸæŸ“å¼•ç™¼æ€¥æ€§è…æå‚·çš„é¢¨éšªã€‚' },
        'vit_d': { level: 'y', title: 'ğŸŸ¡ éœ€ç›£æ¸¬ (Vitamin D)', desc: 'å»ºè­°ç”±é†«å¸«é–‹ç«‹æ´»æ€§ç¶­ç”Ÿç´  Dï¼Œéœ€å®šæœŸç›£æ¸¬è¡€éˆ£èˆ‡è¡€ç£·æ¿ƒåº¦ã€‚' }
    };
    const foodDB = {
        'egg': {t:'ğŸŸ¢ ç¶ ç‡ˆ', d:'å„ªè³ªè›‹ç™½è³ªï¼Œæ¨è–¦é£Ÿç”¨ã€‚'}, 'tofu': {t:'ğŸŸ¢ ç¶ ç‡ˆ', d:'æ¤ç‰©æ€§è›‹ç™½ï¼Œå°¿æ¯’ç´ å°‘ã€‚'}, 'rice_noodle': {t:'ğŸŸ¢ ç¶ ç‡ˆ', d:'ä½æ°®æ¾±ç²‰ï¼Œè£œå……ç†±é‡é¦–é¸ã€‚'}, 'rice': {t:'ğŸŸ¢ ç¶ ç‡ˆ', d:'æ¯”ç³™ç±³ä½ç£·ï¼Œé©åˆæ™šæœŸè…å‹ã€‚'}, 'veg': {t:'ğŸŸ¢ ç¶ ç‡ˆ', d:'ä½é‰€è”¬èœï¼Œé©åˆé£Ÿç”¨ã€‚'}, 'fruit_low': {t:'ğŸŸ¢ ç¶ ç‡ˆ', d:'ä½é‰€æ°´æœï¼Œå¯é©é‡é£Ÿç”¨ã€‚'}, 'oil': {t:'ğŸŸ¢ ç¶ ç‡ˆ', d:'å„ªè³ªå¥½æ²¹ï¼Œä¿è­·å¿ƒè¡€ç®¡ã€‚'},
        'spinach': {t:'ğŸŸ¡ é»ƒç‡ˆ', d:'é«˜é‰€ï¼Œè«‹æ±†ç‡™éå†åƒã€‚'}, 'brown_rice': {t:'ğŸŸ¡ é»ƒç‡ˆ', d:'é«˜ç£·ï¼Œæ™šæœŸå»ºè­°å°‘åƒã€‚'}, 'nuts': {t:'ğŸŸ¡ é»ƒç‡ˆ', d:'ç£·é‰€çš†é«˜ï¼Œä¸€å¤©é™ 5 é¡†ã€‚'}, 'coffee': {t:'ğŸŸ¡ é»ƒç‡ˆ', d:'å«é‰€ä¸”åˆ©å°¿ï¼Œä¸€å¤©ä¸€æ¯ã€‚'}, 'banana': {t:'ğŸŸ¡ é»ƒç‡ˆ', d:'é«˜é‰€æ°´æœï¼Œè¡€é‰€é«˜è€…é¿å…ã€‚'},
        'starfruit': {t:'ğŸ”´ ç´…ç‡ˆ', d:'çµ•å°ç¦æ­¢ï¼å«ç¥ç¶“æ¯’ç´ ã€‚'}, 'sausage': {t:'ğŸ”´ ç´…ç‡ˆ', d:'åŠ å·¥è‚‰å“å«ç„¡æ©Ÿç£·ï¼Œæ¥µå‚·è…ã€‚'}, 'organs': {t:'ğŸ”´ ç´…ç‡ˆ', d:'å…§è‡Ÿé«˜æ¯’ç´ ã€é«˜ç£·ã€‚'}, 'cola': {t:'ğŸ”´ ç´…ç‡ˆ', d:'å«å¤§é‡ç£·é…¸ï¼Œéš±å½¢æ®ºæ‰‹ã€‚'}, 'chicken': {t:'ğŸ”´ ç´…ç‡ˆ', d:'æ¿ƒç¸®é‰€èˆ‡æ™®æ—ï¼ŒåŠ é‡è² æ“”ã€‚'}
    };

    const quizData = [
        {q:"è¦æ”¹åƒã€Œè–„é¹½é†¬æ²¹ã€æˆ–ã€Œä½éˆ‰é¹½ã€å—ï¼Ÿ", a:[{t:"å°ï¼Œå°‘é¹½å°±å¥½",c:false},{t:"éŒ¯ï¼Œé‚£æ˜¯é«˜é‰€é¹½",c:true}], exp:"ä½éˆ‰é¹½é€šå¸¸ä»¥ã€Œé‰€ã€å–ä»£éˆ‰ï¼Œè…å‹æ’é‰€åŠŸèƒ½å·®ï¼Œåƒå¤šæè‡´å¿ƒå¾‹ä¸æ•´ã€‚"},
        {q:"é—œæ–¼å–æ°´ï¼Œä½•è€…æ­£ç¢ºï¼Ÿ", a:[{t:"å®Œå…¨ä¸èƒ½å–æ°´",c:false},{t:"æ²’æ°´è…«æ‡‰é©é‡å–",c:true}], exp:"é™¤éå·²é€ææˆ–åš´é‡æ°´è…«ï¼Œå¦å‰‡æ°´åˆ†ä¸è¶³æœƒæ¸›å°‘è…è‡Ÿè¡€æµï¼Œåè€Œå‚·è…ã€‚"},
        {q:"å¯ä»¥è‡ªå·±è²·ã€Œå¼·æ•ˆæ­¢ç—›è—¥ã€å—ï¼Ÿ", a:[{t:"çµ•å°ä¸å¯",c:true},{t:"å¯ä»¥ï¼Œå°‘åƒå°±å¥½",c:false}], exp:"å¸‚å”®å¼·æ•ˆæ­¢ç—›è—¥(NSAIDs)æœƒæ”¶ç¸®è…è¡€ç®¡ï¼Œæ¥µæ˜“é€ æˆæ€¥æ€§è…æå‚·ã€‚"},
        {q:"å°¿æœ‰æ³¡æ³¡å°±æ˜¯è…è‡Ÿå£äº†å—ï¼Ÿ", a:[{t:"ä¸ä¸€å®šï¼Œéœ€æª¢é©—",c:true},{t:"å°ï¼Œæº–å‚™æ´—è…",c:false}], exp:"å°¿å¤ªæ¿ƒæˆ–è¡åŠ›å¤§ä¹Ÿæœƒæœ‰æ³¡æ³¡ã€‚è‹¥æ³¡æ³¡ã€Œ10åˆ†é˜ä¸æ•£ã€æ‰é«˜åº¦æ‡·ç–‘è›‹ç™½å°¿ã€‚"},
        {q:"æ¥Šæ¡ƒå¾ˆå¥½åƒï¼Œåƒä¸€é»æ²’é—œä¿‚ï¼Ÿ", a:[{t:"çµ•å°ç¦æ­¢",c:true},{t:"å¯ä»¥åƒä¸€å£",c:false}], exp:"æ¥Šæ¡ƒå«ç¥ç¶“æ¯’ç´ ï¼Œè…å‹ç„¡æ³•ä»£è¬ï¼Œé£Ÿç”¨æå°è‡´æŠ½ææ˜è¿·ã€‚"},
        {q:"é—œæ–¼è›‹ç™½è³ªæ”å–ï¼Œå“ªç¨®é¸æ“‡è¼ƒä½³ï¼Ÿ", a:[{t:"åªæœ‰å‹•ç‰©è›‹ç™½",c:false},{t:"æ¤ç‰©æ€§è›‹ç™½å¦‚è±†è…ä¹Ÿä¸éŒ¯",c:true}], exp:"è±†é¡ï¼ˆå¦‚è±†è…ï¼‰æ˜¯å„ªè³ªæ¤ç‰©æ€§è›‹ç™½ï¼Œèƒ½æ¸›å°‘å«æ°®å»¢ç‰©ç”¢ç”Ÿï¼Œé©åˆè…å‹é£Ÿç”¨ã€‚"},
        {q:"è¡€å£“è—¥åƒå¤šäº†æœƒå‚·è…ï¼Œæ‰€ä»¥è¡€å£“æ­£å¸¸å°±è©²åœè—¥ï¼Ÿ", a:[{t:"å°ï¼Œåƒè—¥å‚·è…",c:false},{t:"éŒ¯ï¼Œæ“…è‡ªåœè—¥æ›´å‚·è…",c:true}], exp:"é«˜è¡€å£“æ˜¯æ´—è…ä¸»å› ä¹‹ä¸€ï¼Œç©©å®šæ§åˆ¶è¡€å£“åè€Œèƒ½ä¿è­·è…è‡Ÿï¼Œåˆ‡å‹¿è‡ªè¡Œåœè—¥ã€‚"},
        {q:"åŠ å·¥é£Ÿå“ï¼ˆå¦‚é¦™è…¸ã€è²¢ä¸¸ï¼‰ç‚ºä»€éº¼å°‘åƒï¼Ÿ", a:[{t:"ç†±é‡å¤ªä½",c:false},{t:"å«é«˜é‡ç„¡æ©Ÿç£·ï¼Œå‚·è…",c:true}], exp:"åŠ å·¥é£Ÿå“æ·»åŠ çš„ç£·é…¸é¹½ï¼ˆç„¡æ©Ÿç£·ï¼‰å¸æ”¶ç‡é«˜é”100%ï¼Œæ¥µæ˜“é€ æˆé«˜è¡€ç£·ï¼Œå°è‡´è¡€ç®¡éˆ£åŒ–ã€‚"},
        {q:"è…è‡Ÿç—…åˆæœŸé€šå¸¸æœ‰ä»€éº¼æ˜é¡¯ç—‡ç‹€ï¼Ÿ", a:[{t:"è…°è¶…ç—›",c:false},{t:"é€šå¸¸æ²’ç—‡ç‹€ï¼Œéœ€é æª¢æŸ¥",c:true}], exp:"è…è‡Ÿæ˜¯æ²‰é»˜çš„å™¨å®˜ï¼ŒåˆæœŸå¤šç„¡ç—‡ç‹€ï¼Œå®šæœŸæŠ½è¡€é©—å°¿æ‰æ˜¯å”¯ä¸€ç™¼ç¾é€”å¾‘ã€‚"},
        {q:"è½èªªã€Œæ´—è…ã€å¾Œäººç”Ÿå°±é»‘ç™½äº†ï¼Ÿ", a:[{t:"å°ï¼Œæ²’æ•‘äº†",c:false},{t:"éŒ¯ï¼Œä»å¯ç¶­æŒç”Ÿæ´»å“è³ª",c:true}], exp:"é…åˆæ²»ç™‚èˆ‡é€æï¼Œè¨±å¤šè…å‹ä»èƒ½å‡ºåœ‹æ—…éŠã€å·¥ä½œï¼Œç”Ÿæ´»ä¾ç„¶å¯ä»¥å¾ˆç²¾å½©ã€‚"}
    ];

    // --- Logic ---
    function switchTab(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('tab-' + id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        const idx = (id==='home')?0:(id==='meds')?1:(id==='diet')?2:(id==='quiz')?3:4;
        document.querySelectorAll('.nav-item')[idx].classList.add('active');
        window.scrollTo(0,0);
        if (id === 'diet') updateProteinIntake();
    }
    
    function updateAllRisks() {
        const age = parseFloat(document.getElementById('kfre-age').value);
        const sex = document.getElementById('kfre-sex').value;
        const egfr = parseFloat(document.getElementById('kfre-egfr').value);
        const uacr = parseFloat(document.getElementById('kfre-uacr').value);
        const weight = parseFloat(document.getElementById('kfre-weight').value);
        const dmVal = document.getElementById('kfre-dm').value;
        const hasDM = dmVal === '1'; 
        
        if (weight && !isNaN(weight)) localStorage.setItem('userWeight', weight);
        if (isNaN(age) || sex === "" || isNaN(egfr) || isNaN(uacr) || dmVal === "") return;

        document.getElementById('start-hint').classList.add('hidden');
        document.getElementById('unified-result').classList.remove('hidden');

        // Heatmap
        document.querySelectorAll('.matrix-cell').forEach(c => c.classList.remove('active-cell'));
        let row = '5', stageText = 'ç¬¬5æœŸ';
        if (egfr >= 90) { row = '1'; stageText = 'ç¬¬1æœŸ'; }
        else if (egfr >= 60) { row = '2'; stageText = 'ç¬¬2æœŸ'; }
        else if (egfr >= 45) { row = '3a'; stageText = 'ç¬¬3aæœŸ'; }
        else if (egfr >= 30) { row = '3b'; stageText = 'ç¬¬3bæœŸ'; }
        else if (egfr >= 15) { row = '4'; stageText = 'ç¬¬4æœŸ'; }
        localStorage.setItem('ckdStage', row);

        let col = '1', uacrText = 'æ­£å¸¸/è¼•å¾®';
        if (uacr >= 300) { col = '3'; uacrText = 'åš´é‡è›‹ç™½å°¿'; } 
        else if (uacr >= 300) { col = '2'; uacrText = 'å¾®é‡è›‹ç™½å°¿'; }

        const cellId = `cell-${row}-${col}`;
        const cell = document.getElementById(cellId);
        if (cell) cell.classList.add('active-cell');

        let color = '#e03e2e', text = 'è¶…é«˜é¢¨éšª';
        if (cell.classList.contains('bg-g')) { color = '#6bbd45'; text = 'ä½é¢¨éšª (å®šæœŸè¿½è¹¤)'; }
        else if (cell.classList.contains('bg-y')) { color = '#ffd700'; text = 'ä¸­åº¦é¢¨éšª (éœ€æ³¨æ„)'; }
        else if (cell.classList.contains('bg-o')) { color = '#f58220'; text = 'é«˜é¢¨éšª (åš´æ ¼æ§åˆ¶)'; }

        const banner = document.getElementById('risk-banner');
        banner.style.backgroundColor = color;
        banner.style.color = (color === '#ffd700') ? '#222' : '#fff'; 
        document.getElementById('risk-title').innerText = text;
        document.getElementById('risk-desc').innerText = `è…çµ²çƒéæ¿¾ç‡${stageText} + ${uacrText}`;

        updateMeds(egfr, hasDM);
        updateDiet(egfr, hasDM);
        updateArmorVisibility(hasDM, egfr); 

        // KFRE
        const sexNum = parseFloat(sex);
        const logACR = Math.log(uacr);
        const sum = -0.2201 * (age/10 - 7.036) + 0.2467 * (sexNum - 0.5642) - 0.5567 * (egfr/5 - 7.222) + 0.4510 * (logACR - 5.137);
        const risk2 = 1 - Math.pow(0.9832, Math.exp(sum));
        const risk5 = 1 - Math.pow(0.9365, Math.exp(sum));
        document.getElementById('res-2yr').innerText = (risk2 * 100).toFixed(1) + "%";
        document.getElementById('res-5yr').innerText = (risk5 * 100).toFixed(1) + "%";

        const adviceBox = document.getElementById('kfre-advice-box');
        let adviceHTML = "", adviceBorder = "#ccc";
        let dmContext = hasDM ? "ä¸”åˆä½µç³–å°¿ç—…" : "";

        if (risk2 >= 0.4) { 
            adviceBorder = "#d32f2f";
            adviceHTML = `æ‚¨çš„æ•¸å€¼é¡¯ç¤ºè…åŠŸèƒ½è¡°é€€é¢¨éšªè¼ƒé«˜${dmContext}ã€‚å»ºè­°é–‹å§‹èˆ‡é†«å¸«è¨è«–é€ææ¨¡å¼é¸æ“‡ï¼Œæˆ–è©•ä¼°è¡€ç®¡é€šè·¯å»ºç«‹ã€‚`;
        } else if (risk2 >= 0.1) { 
            adviceBorder = "#f57c00";
            adviceHTML = `å»ºè­°åŠ å…¥ã€Œæ…¢æ€§è…è‡Ÿç—…æ•´é«”ç…§è­·è¨ˆç•«ã€ã€‚${hasDM ? "è«‹å‹™å¿…åš´æ ¼æ§åˆ¶è¡€ç³– (HbA1c < 7%)ã€‚" : ""}`;
        } else if (risk5 >= 0.03) { 
            adviceBorder = "#fbc02d";
            adviceHTML = `å»ºè­°è½‰è¨ºè‡³è…è‡Ÿå°ˆç§‘ç¢ºèªç—…å› ã€‚${hasDM ? "ç³–å°¿ç—…æ˜¯è…è‡Ÿæƒ¡åŒ–ä¸»å› ï¼Œè«‹æŒ‰æ™‚æœè—¥ã€‚" : "è«‹å®šæœŸè¿½è¹¤è¡€å£“èˆ‡å°¿è›‹ç™½ã€‚"}`;
        } else {
            adviceBorder = "#388e3c";
            adviceHTML = `ç›®å‰çŸ­æœŸå…§æ´—è…æ©Ÿç‡è¼ƒä½ã€‚è«‹ç¶­æŒå¥åº·ç”Ÿæ´»ï¼Œæ¯å¹´å®šæœŸè¿½è¹¤å³å¯ã€‚`;
        }
        if (egfr >= 60) adviceHTML += `<br><span style="font-size:0.9rem; color:#777; display:block; margin-top:8px;">(è¨»ï¼šå…¬å¼ä¸»è¦é‡å° eGFR < 60 è¨­è¨ˆï¼Œæ‚¨çš„è…åŠŸèƒ½å°šä½³ï¼Œåƒè€ƒå³å¯ã€‚)</span>`;
        adviceBox.innerHTML = adviceHTML;
        adviceBox.style.borderLeftColor = adviceBorder;
    }

    function updateMeds(egfr, hasDM) {
        document.getElementById('med-placeholder').classList.add('hidden');
        document.getElementById('med-content').classList.remove('hidden');
        const sel = document.getElementById('kfre-egfr');
        document.getElementById('med-egfr-val').innerText = sel.options[sel.selectedIndex].text;
        const uacr = document.getElementById('kfre-uacr').value;
        const g = document.getElementById('list-med-g'), y = document.getElementById('list-med-y'), r = document.getElementById('list-med-r');
        g.innerHTML = ''; y.innerHTML = ''; r.innerHTML = '';
        function add(list, title, desc) { list.innerHTML += `<div class="list-item"><span class="list-title">${title}</span><span style="color:#555;">${desc}</span></div>`; }

        add(g, "RASi (ACEi / ARB)", "ç¬¬ä¸€ç·šè­·è…è¡€å£“è—¥ï¼ŒæŠ—è›‹ç™½å°¿é¦–é¸ã€‚");
        if (egfr >= 20) {
            let msg = hasDM ? "å¼·çƒˆå»ºè­°ï¼æ§ç³–åŒæ™‚è­·è…ã€è­·å¿ƒã€‚" : "å¼·çƒˆå»ºè­°ï¼é›–ç„¡ç³–å°¿ç—…ï¼Œä½†å°æ”¹å–„è›‹ç™½å°¿èˆ‡è­·è…æ•ˆæœé¡¯è‘—ã€‚";
            add(g, "SGLT2i (æ’ç³–è—¥)", msg);
        } else add(y, "SGLT2i (æ’ç³–è—¥)", "eGFR < 20 ä¸å»ºè­°æ–°èµ·å§‹ï¼Œä½†è‹¥åŸå…ˆå·²æœç”¨å¯çºŒç”¨ã€‚");

        if (hasDM) {
            // ç”¨è—¥å»ºè­°ä¿®æ­£ï¼šeGFR >= 25 ä¸”è›‹ç™½å°¿ç•°å¸¸ (30) æ‰æœƒå»ºè­°
            if (egfr >= 25 && uacr >= 30) add(g, "ns-MRA (Finerenone)", "é‡å°ç³–å°¿ç—…åˆä½µè›‹ç™½å°¿ï¼Œå»ºè­°è«®è©¢é†«å¸«åŠ ç”¨ã€‚");
            add(g, "GLP-1 RA (è…¸æ³Œç´ )", "é‡å°ç³–å°¿ç—…è…ç—…è®Šï¼Œå…·å„ªç§€çš„è­·è…èˆ‡è­·å¿ƒå¯¦è­‰ã€‚");
        }
        add(g, "Statins (é™è¡€è„‚è—¥)", "é é˜²ä¸­é¢¨èˆ‡å¿ƒè¡€ç®¡äº‹ä»¶ï¼Œå»ºè­°æŒçºŒæœç”¨ã€‚");

        if (hasDM) {
            if (egfr < 30) add(r, "Metformin (é™ç³–è—¥)", "eGFR < 30 ç¦ç”¨ï¼ä¹³é…¸ä¸­æ¯’é¢¨éšªé«˜ã€‚");
            else if (egfr < 45) add(y, "Metformin (é™ç³–è—¥)", "eGFR 30-45 éœ€æ¸›é‡ï¼Œæ¯æ—¥ä¸è¶…é 1000mgã€‚");
        }
        add(y, "Diuretics (åˆ©å°¿åŠ‘)", "ç”Ÿç—…(è„«æ°´)æ™‚éœ€æš«åœã€‚");
        add(r, "NSAIDs (å¼·æ•ˆæ­¢ç—›è—¥)", "å‚·è…åœ°é›·ï¼çµ•å°ç¦æ­¢ã€‚");
        add(r, "å«ç¢˜é¡¯å½±åŠ‘", "æª¢æŸ¥å‰å‹™å¿…å‘ŠçŸ¥é†«å¸«ã€‚");
    }

    function updateDiet(egfr, hasDM) {
        document.getElementById('diet-placeholder').classList.add('hidden');
        document.getElementById('diet-content').classList.remove('hidden');
        const g = document.getElementById('list-diet-g'), y = document.getElementById('list-diet-y'), r = document.getElementById('list-diet-r');
        g.innerHTML = ''; y.innerHTML = ''; r.innerHTML = '';
        function add(list, title, desc) { list.innerHTML += `<div class="list-item"><span class="list-title">${title}</span><span style="color:#555;">${desc}</span></div>`; }

        add(g, "å„ªè³ªè›‹ç™½è³ª", "é›è›‹ã€è±†è…ã€é­šè‚‰ã€‚");
        add(g, "å¤©ç„¶å¥½æ²¹", "æ©„æ¬–æ²¹ã€è‹¦èŒ¶æ²¹ã€‚");
        if (hasDM) {
            add(y, "ç²¾ç·»ç³–/ç”œé£Ÿ", "è¡€ç³–æ§åˆ¶ä¸ä½³æœƒåŠ é€Ÿè…åŠŸèƒ½æƒ¡åŒ–ï¼Œè«‹åš´æ ¼å¿Œå£ã€‚");
            add(g, "ä½å‡ç³–(GI)é£Ÿç‰©", "å…¨ç©€é›œç³§ã€è”¬èœï¼Œæœ‰åŠ©è¡€ç³–ç©©å®šã€‚");
        } else {
            add(g, "é©é‡æ°´æœ", "è‹¥è¡€ç³–æ­£å¸¸ï¼Œå¯é©é‡æ”å–ä½é‰€æ°´æœã€‚");
        }
        if (egfr < 45) { 
            add(g, "ä½æ°®æ¾±ç²‰", "å†¬ç²‰ã€ç±³ç²‰ã€‚è£œå……ç†±é‡ä¸å‚·è…ã€‚");
            add(y, "ç³™ç±³/äº”ç©€ç±³", "ç£·å«é‡é«˜ï¼Œæ™šæœŸå»ºè­°å°‘åƒã€‚");
            add(y, "æ·±ç¶ è‰²è”¬èœ", "é‰€é«˜ï¼Œå»ºè­°åˆ‡æ®µæ±†ç‡™ã€‚");
            add(r, "ä½éˆ‰é¹½", "é€šå¸¸æ˜¯ã€Œé«˜é‰€é¹½ã€ï¼Œæè‡´å¿ƒå¾‹ä¸æ•´ã€‚");
        }
        add(r, "æ¥Šæ¡ƒ", "çµ•å°ç¦æ­¢ï¼å«ç¥ç¶“æ¯’ç´ ã€‚");
        add(r, "åŠ å·¥è‚‰å“", "é¦™è…¸ç«è…¿å«é«˜ç£·ã€‚");
    }

    function checkMed() {
        const val = document.getElementById('med-select').value;
        const lights = document.querySelectorAll('.light');
        const res = document.getElementById('med-result');
        lights.forEach(l => l.classList.remove('on'));
        res.classList.add('hidden');
        if(!val) return;
        const data = medDB[val];
        res.classList.remove('hidden');
        res.innerHTML = `<strong>${data.title}</strong><br>${data.desc}`;
        if (data.level === 'r') { document.getElementById('light-r').classList.add('on'); res.style.borderColor = "var(--risk-r)"; res.style.background = "#fff5f5"; }
        else if (data.level === 'y') { document.getElementById('light-y').classList.add('on'); res.style.borderColor = "var(--risk-y)"; res.style.background = "#fffbf0"; }
        else { document.getElementById('light-g').classList.add('on'); res.style.borderColor = "var(--risk-g)"; res.style.background = "#e6fffa"; }
    }

    function checkFood() {
        const val = document.getElementById('food-select').value;
        const res = document.getElementById('food-result');
        res.classList.add('hidden');
        if(!val) return;
        const data = foodDB[val];
        res.classList.remove('hidden');
        res.innerHTML = `<strong style="font-size:1.4rem;">${data.t}</strong><br>${data.d}`;
        if(data.t.includes('ç´…')) { res.style.borderColor = 'red'; res.style.background = '#fff5f5'; }
        else if(data.t.includes('é»ƒ')) { res.style.borderColor = 'gold'; res.style.background = '#fffbe6'; }
        else { res.style.borderColor = 'green'; res.style.background = '#e8f5e9'; }
    }

    // --- Quiz Logic ---
    let qIdx = 0, score = 0;
    function initQuiz() { 
        qIdx=0; score=0; 
        document.getElementById('quiz-score').classList.add('hidden'); 
        document.getElementById('quiz-area').classList.remove('hidden'); 
        renderQ(); 
    }
    function renderQ() {
        const q = quizData[qIdx];
        document.getElementById('quiz-counter').innerText = `Q${qIdx+1}/${quizData.length}`;
        document.getElementById('quiz-question').innerText = q.q;
        document.getElementById('quiz-feedback').classList.add('hidden');
        const div = document.getElementById('quiz-options');
        div.innerHTML = '';
        q.a.forEach(opt => {
            const btn = document.createElement('div');
            btn.className = 'quiz-option';
            btn.innerText = opt.t;
            btn.onclick = () => {
                playSound(opt.c);
                document.querySelectorAll('.quiz-option').forEach(b=>b.style.pointerEvents='none');
                if(opt.c) { btn.classList.add('correct'); score+=10; document.getElementById('quiz-res-text').innerText="ğŸ‰ ç­”å°äº†ï¼"; document.getElementById('quiz-res-text').style.color="green"; }
                else { btn.classList.add('wrong'); document.getElementById('quiz-res-text').innerText="ğŸ˜± ç­”éŒ¯å›‰ï¼"; document.getElementById('quiz-res-text').style.color="red"; }
                document.getElementById('quiz-exp').innerText = q.exp;
                document.getElementById('quiz-feedback').classList.remove('hidden');
            };
            div.appendChild(btn);
        });
        document.querySelector('.progress-fill').style.width = `${((qIdx)/quizData.length)*100}%`;
    }
    function nextQ() {
        qIdx++;
        if(qIdx < quizData.length) renderQ();
        else {
            document.getElementById('quiz-area').classList.add('hidden');
            document.getElementById('quiz-feedback').classList.add('hidden');
            document.getElementById('quiz-score').classList.remove('hidden');
            document.getElementById('final-score').innerText = score;
            document.querySelector('.progress-fill').style.width = '100%';
            let comment = "";
            if (score === 100) comment = "ğŸ† å¤ªå¼·äº†ï¼ä½ æ˜¯è­·è…é”äººï¼";
            else if (score >= 60) comment = "ğŸ‘ å¾ˆä¸éŒ¯ï¼Œç¹¼çºŒä¿æŒï¼";
            else comment = "ğŸ’ª åŠ æ²¹ï¼Œå¤šçœ‹å¹¾æ¬¡è¡›æ•™è³‡è¨Šå–”ï¼";
            document.getElementById('score-comment').innerText = comment;
        }
    }

    // Protein Calc
    function updateProteinIntake() {
        var weight = parseFloat(localStorage.getItem('userWeight'));
        var stage = localStorage.getItem('ckdStage'); 
        var displayDiv = document.getElementById('protein-calc-display');
        if (!weight || isNaN(weight)) { if(displayDiv) displayDiv.style.display = 'none'; return; }
        var factorMin = 0.8, factorMax = 1.0;
        if (stage && (stage.includes('3') || stage.includes('4') || stage.includes('5'))) { factorMin = 0.6; factorMax = 0.8; }
        var pMin = (weight * factorMin).toFixed(1);
        var pMax = (weight * factorMax).toFixed(1);
        var portions = Math.round((weight * (factorMin + factorMax) / 2) / 7);
        document.getElementById('display-weight').innerText = weight;
        document.getElementById('display-protein-min').innerText = pMin;
        document.getElementById('display-protein-max').innerText = pMax;
        document.getElementById('display-protein-portions').innerText = portions;
        if(displayDiv) displayDiv.style.display = 'block';
    }

    // 4. è£å‚™æ¬„é¡¯ç¤ºæ§åˆ¶ (ä¿®æ­£é‚è¼¯: eGFR < 25 éš±è— ns-MRA)
    function updateArmorVisibility(hasDM, egfr) {
        const slotGlp1 = document.getElementById('slot-glp1');
        const slotNsmra = document.getElementById('slot-nsmra');
        
        // ns-MRA: å¿…é ˆæœ‰ç³–å°¿ç—… ä¸” eGFR >= 25 æ‰é¡¯ç¤º (èˆ‡ç”¨è—¥å»ºè­°åŒæ­¥)
        if (!hasDM || egfr < 25) {
            document.getElementById('drug-nsmra').checked = false;
            slotNsmra.classList.remove('equipped');
            slotNsmra.style.display = 'none';
        } else {
            slotNsmra.style.display = 'flex';
        }

        // GLP-1: åƒ…çœ‹ç³–å°¿ç—…
        if (!hasDM) {
            document.getElementById('drug-glp1').checked = false;
            slotGlp1.classList.remove('equipped');
            slotGlp1.style.display = 'none';
        } else {
            slotGlp1.style.display = 'flex';
        }

        updateStatusAndAdvice();
    }

    const ranks = [
        { count: 0, class: 'status-novice', title: 'æ–°æ‰‹å†’éšªè€… (Novice)', icon: 'âš ï¸', msg: 'å“å‘€ï¼æ‚¨çš„è…è‡Ÿç›®å‰å®Œå…¨æ²’æœ‰é˜²è­·ï¼Œè«‹ç›¡å¿«è«®è©¢é†«å¸«ï¼' },
        { count: 1, class: 'status-apprentice', title: 'è¦‹ç¿’è¡›å£« (Apprentice)', icon: 'ğŸ›¡ï¸', msg: 'å¾ˆå¥½ï¼æ‚¨ç©¿ä¸Šäº†ç¬¬ä¸€ä»¶è£å‚™ï¼Œé–‹å§‹ä¿è­·è…è‡Ÿäº†ã€‚' },
        { count: 2, class: 'status-veteran', title: 'è³‡æ·±é¨å£« (Veteran)', icon: 'âš”ï¸', msg: 'å¤ªæ£’äº†ï¼æ‚¨çš„é˜²ç¦¦åŠ›å¤§å¹…æå‡ï¼Œå·²ç¶“è´éå¾ˆå¤šäººå›‰ï¼' },
        { count: 3, class: 'status-elite', title: 'çš‡å®¶è­·è¡› (Elite)', icon: 'ğŸ°', msg: 'éå¸¸å„ªç§€ï¼æ‚¨çš„è…è‡Ÿå—åˆ°åš´å¯†çš„ä¿è­·ï¼Œè«‹ç¹¼çºŒä¿æŒï¼' },
        { count: 4, class: 'status-guardian', title: 'è…è‡Ÿå®ˆè­·ç¥ (Guardian)', icon: 'ğŸ†', msg: 'å®Œç¾ç„¡ç¼ºï¼æ‚¨æ“æœ‰æœ€å¼·çš„è£å‚™é™£å®¹ï¼Œæ˜¯å¥åº·çš„æ¨¡ç¯„ç”Ÿï¼' }
    ];

    function updateStatusAndAdvice() {
        const checkboxes = document.querySelectorAll('.gear-checkbox');
        let checkedCount = 0;
        checkboxes.forEach(box => { 
            // åªè¨ˆç®—é¡¯ç¤ºä¸­çš„é …ç›®
            if (box.parentElement.style.display !== 'none' && box.checked) {
                checkedCount++; 
            }
        });
        
        let rankIndex = checkedCount; if (rankIndex >= 4) rankIndex = 4;
        const data = ranks[rankIndex];
        const statusPanel = document.getElementById('status-panel');
        document.getElementById('status-title').innerText = data.title;
        document.getElementById('status-icon').innerText = data.icon;
        document.getElementById('status-msg').innerText = data.msg;
        statusPanel.className = 'status-panel ' + data.class;
        statusPanel.classList.remove('animate-pop');
        void statusPanel.offsetWidth;
        statusPanel.classList.add('animate-pop');

        generateAdvice();
    }

    function toggleEquip(element, checkboxId) {
        var checkbox = document.getElementById(checkboxId);
        checkbox.checked = !checkbox.checked;
        if(checkbox.checked) { element.classList.add('equipped'); playSound(true); } 
        else { element.classList.remove('equipped'); }
        updateStatusAndAdvice();
    }

    function generateAdvice() {
        var egfrSel = document.getElementById('kfre-egfr');
        var uacrSel = document.getElementById('kfre-uacr');
        var dmSel = document.getElementById('kfre-dm');
        var egfr = egfrSel.value ? parseFloat(egfrSel.value) : 0;
        var uacr = uacrSel.value ? parseFloat(uacrSel.value) : 0;
        var hasDM = dmSel.value === '1'; 

        var useSglt2 = document.getElementById('drug-sglt2').checked;
        var useRasi = document.getElementById('drug-rasi').checked;
        var useNsmra = document.getElementById('drug-nsmra').checked;
        var useStatin = document.getElementById('drug-statin').checked;
        var useGlp1 = document.getElementById('drug-glp1').checked;

        var adviceHTML = "";

        // 1. SGLT2 (ç‰¹æ®Šå¼·èª¿ KDIGO 2024)
        if (useSglt2) {
            adviceHTML += `<div style="background:#e8f5e9; padding:12px; border-left:5px solid #2e7d32; margin-bottom:12px; border-radius:5px;">âœ… <strong>æ’ç³–è—¥ (SGLT2i)ï¼š</strong>å¤ªæ£’äº†ï¼é€™æ˜¯ KDIGO æŒ‡å¼•èªè­‰æœ€å¼·çš„è­·è…ç¥ç›¾ã€‚</div>`;
        } else if (egfr >= 20) {
            let tip = hasDM ? "æ‚¨æœ‰ç³–å°¿ç—…" : "å³ä½¿æ²’æœ‰ç³–å°¿ç—…";
            adviceHTML += `<div style="background:#fffde7; border: 2px solid #ff8f00; padding: 15px; margin-bottom: 12px; border-radius: 8px; box-shadow: 0 4px 10px rgba(255, 143, 0, 0.15);"><span style="background:#d32f2f; color:white; padding:3px 8px; border-radius:4px; font-size:0.9rem; font-weight:bold; display:inline-block; margin-bottom:5px;">ğŸ”¥ KDIGO 2024 æ–°æŒ‡å¼•é¦–é¸</span><br><strong style="color:#d84315; font-size:1.1rem;">å»ºè­°å„ªå…ˆè«®è©¢ï¼</strong><p style="margin:5px 0 0 0; color:#333;">${tip}ï¼Œæ­¤è—¥ç‰©å·²è¢«è­‰å¯¦èƒ½é¡¯è‘—å»¶ç·©è…åŠŸèƒ½æƒ¡åŒ–èˆ‡ä¿è­·å¿ƒè‡Ÿï¼Œæ˜¯ç›®å‰çš„æ²»ç™‚æ ¸å¿ƒã€‚</p></div>`;
        }

        // 2. GLP-1
        if (hasDM) {
            if (useGlp1) adviceHTML += `<div style="background:#e8f5e9; padding:10px; border-left:5px solid #2e7d32; margin-bottom:10px; border-radius:5px;">âœ… <strong>è…¸æ³Œç´  (GLP-1 RA)ï¼š</strong>å¼·å¤§çš„æ§ç³–é­”æ–ï¼ä¿è­·è…è‡ŸåŒæ™‚æ§åˆ¶é«”é‡ã€‚</div>`;
            else adviceHTML += `<div style="background:#fff3e0; padding:10px; border-left:5px solid #ff9800; margin-bottom:10px; border-radius:5px;">ğŸ’¡ <strong>æ–°è—¥è¶¨å‹¢ï¼š</strong>GLP-1 è…¸æ³Œç´ æ˜¯ç³–å°¿ç—…è­·è…æ–°æ”¯æŸ±ï¼Œè‹¥è¡€ç³–æˆ–é«”é‡æ§åˆ¶ä¸ä½³ï¼Œå¯è«®è©¢é†«å¸«ã€‚</div>`;
        }

        // 3. RASi
        if (useRasi) adviceHTML += `<div style="background:#e8f5e9; padding:10px; border-left:5px solid #2e7d32; margin-bottom:10px; border-radius:5px;">âœ… <strong>RASi è¡€å£“è—¥ï¼š</strong>åŸºç¤è­·ç”²ï¼Œå°æŠ—è›‹ç™½å°¿ä¸å¯æˆ–ç¼ºã€‚</div>`;
        else if (uacr >= 30) adviceHTML += `<div style="background:#fff3e0; padding:10px; border-left:5px solid #ff9800; margin-bottom:10px; border-radius:5px;">ğŸ’¡ <strong>å»ºè­°è«®è©¢ï¼š</strong>æ‚¨æœ‰è›‹ç™½å°¿ï¼ŒRASi é¡è¡€å£“è—¥æ˜¯é¦–é¸æ²»ç™‚ã€‚</div>`;

        // 4. ns-MRA (eGFR >= 25 æ‰é¡¯ç¤ºå»ºè­°)
        if (hasDM && egfr >= 25) { 
            if (useNsmra) adviceHTML += `<div style="background:#e8f5e9; padding:10px; border-left:5px solid #2e7d32; margin-bottom:10px; border-radius:5px;">âœ… <strong>æ–°å‹è­·è…è—¥ (ns-MRA)ï¼š</strong>é€²éšè£å‚™ï¼èƒ½æŠ—ç™¼ç‚ã€æŠ—çº–ç¶­åŒ–ã€‚</div>`;
            else if (uacr >= 30) adviceHTML += `<div style="background:#fff3e0; padding:10px; border-left:5px solid #ff9800; margin-bottom:10px; border-radius:5px;">ğŸ’¡ <strong>æ–°è—¥è³‡è¨Šï¼š</strong>ç³–å°¿ç—…+è›‹ç™½å°¿ï¼Œè‹¥è¡€é‰€æ­£å¸¸ï¼Œå¯è«®è©¢æ˜¯å¦ä½¿ç”¨ Finerenoneã€‚</div>`;
        }

        // 5. Statin
        if (useStatin) adviceHTML += `<div style="background:#e8f5e9; padding:10px; border-left:5px solid #2e7d32; margin-bottom:10px; border-radius:5px;">âœ… <strong>é™è¡€è„‚è—¥ (Statin)ï¼š</strong>ä¿è­·è¡€ç®¡ï¼Œé é˜²ä¸­é¢¨ã€‚</div>`;
        else if (egfr < 60) adviceHTML += `<div style="background:#fff3e0; padding:10px; border-left:5px solid #ff9800; margin-bottom:10px; border-radius:5px;">ğŸ’¡ <strong>å»ºè­°è«®è©¢ï¼š</strong>è…å‹å¿ƒè¡€ç®¡é¢¨éšªé«˜ï¼ŒStatin æ˜¯é‡è¦é˜²è­·ã€‚</div>`;

        var adviceDiv = document.getElementById('dynamic-advice');
        if (adviceHTML !== "") { adviceDiv.innerHTML = adviceHTML; adviceDiv.classList.remove('hidden'); } 
        else { adviceDiv.classList.add('hidden'); }
    }

    initQuiz();
</script>
</body>
</html>
